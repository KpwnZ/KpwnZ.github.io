<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Voucher, Port and Message: Exploit CVE-2019-6225 on macOS | </title><meta name="keywords" content="Vulnerability,XNU,macOS,iOS,exploit"><meta name="author" content="KpwnZ"><meta name="copyright" content="KpwnZ"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="CVE-2019-6225 Vulnerability The problem is in the MIG code. 1234routine task_swap_mach_voucher(                task            : task_t;                new_voucher     : ipc_voucher_t;        inout">
<meta property="og:type" content="article">
<meta property="og:title" content="Voucher, Port and Message: Exploit CVE-2019-6225 on macOS">
<meta property="og:url" content="https://kpwnz.github.io/2022/02/01/Voucher-Port-and-Message-Exploit-CVE-2019-6225-on-macOS/index.html">
<meta property="og:site_name">
<meta property="og:description" content="CVE-2019-6225 Vulnerability The problem is in the MIG code. 1234routine task_swap_mach_voucher(                task            : task_t;                new_voucher     : ipc_voucher_t;        inout">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://source.unsplash.com/featured/?landscape,tech,life">
<meta property="article:published_time" content="2022-02-01T08:18:49.000Z">
<meta property="article:modified_time" content="2022-04-04T09:51:18.357Z">
<meta property="article:author" content="KpwnZ">
<meta property="article:tag" content="Vulnerability">
<meta property="article:tag" content="XNU">
<meta property="article:tag" content="macOS">
<meta property="article:tag" content="iOS">
<meta property="article:tag" content="exploit">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://source.unsplash.com/featured/?landscape,tech,life"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://kpwnz.github.io/2022/02/01/Voucher-Port-and-Message-Exploit-CVE-2019-6225-on-macOS/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Voucher, Port and Message: Exploit CVE-2019-6225 on macOS',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-04-04 17:51:18'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://avatars.githubusercontent.com/u/22996989?s=400&amp;u=470b81ce0dd0fd2e15880f564e1bef0ba9655225&amp;v=4" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">14</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">16</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://source.unsplash.com/featured/?landscape,tech,life')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/"></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Voucher, Port and Message: Exploit CVE-2019-6225 on macOS</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-02-01T08:18:49.000Z" title="Created 2022-02-01 16:18:49">2022-02-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-04-04T09:51:18.357Z" title="Updated 2022-04-04 17:51:18">2022-04-04</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Voucher, Port and Message: Exploit CVE-2019-6225 on macOS"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>CVE-2019-6225</h1>
<h2 id="Vulnerability">Vulnerability</h2>
<p>The problem is in the MIG code.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">routine <span class="title">task_swap_mach_voucher</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">                task            : <span class="keyword">task_t</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">                new_voucher     : <span class="keyword">ipc_voucher_t</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">        inout   old_voucher     : <span class="keyword">ipc_voucher_t</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>this routine simply swaps two vouchers. Let’s take a look at the following codes.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">mig_internal novalue _Xtask_swap_mach_voucher</span><br><span class="line">       (<span class="keyword">mach_msg_header_t</span> *InHeadP, <span class="keyword">mach_msg_header_t</span> *OutHeadP)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">   <span class="keyword">kern_return_t</span> RetCode;</span><br><span class="line">   <span class="keyword">task_t</span> task;</span><br><span class="line">   <span class="keyword">ipc_voucher_t</span> new_voucher;</span><br><span class="line">   <span class="keyword">ipc_voucher_t</span> old_voucher;</span><br><span class="line">...</span><br><span class="line">   task = convert_port_to_task(In0P-&gt;Head.msgh_request_port);</span><br><span class="line"></span><br><span class="line">   new_voucher = convert_port_to_voucher(In0P-&gt;new_voucher.name);</span><br><span class="line"></span><br><span class="line">   old_voucher = convert_port_to_voucher(In0P-&gt;old_voucher.name);</span><br><span class="line"></span><br><span class="line">   RetCode = task_swap_mach_voucher(task, new_voucher, &amp;old_voucher);</span><br><span class="line"></span><br><span class="line">   ipc_voucher_release(new_voucher);</span><br><span class="line"></span><br><span class="line">   task_deallocate(task);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (RetCode != KERN_SUCCESS) &#123;</span><br><span class="line">       MIG_RETURN_ERROR(OutP, RetCode);</span><br><span class="line">   &#125;</span><br><span class="line">...</span><br><span class="line">   <span class="keyword">if</span> (IP_VALID((<span class="keyword">ipc_port_t</span>)In0P-&gt;old_voucher.name))</span><br><span class="line">       ipc_port_release_send((<span class="keyword">ipc_port_t</span>)In0P-&gt;old_voucher.name);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (IP_VALID((<span class="keyword">ipc_port_t</span>)In0P-&gt;new_voucher.name))</span><br><span class="line">       ipc_port_release_send((<span class="keyword">ipc_port_t</span>)In0P-&gt;new_voucher.name);</span><br><span class="line">...</span><br><span class="line">   OutP-&gt;old_voucher.name = (<span class="keyword">mach_port_t</span>)convert_voucher_to_port(old_voucher);</span><br><span class="line"></span><br><span class="line">   OutP-&gt;Head.msgh_bits |= MACH_MSGH_BITS_COMPLEX;</span><br><span class="line">   OutP-&gt;Head.msgh_size = (<span class="keyword">mach_msg_size_t</span>)(<span class="keyword">sizeof</span>(Reply));</span><br><span class="line">   OutP-&gt;msgh_body.msgh_descriptor_count = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Well, everything seems correct here. Increase reference count and decrease it later.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">new_voucher = convert_port_to_voucher(In0P-&gt;new_voucher.name);</span><br><span class="line"></span><br><span class="line">old_voucher = convert_port_to_voucher(In0P-&gt;old_voucher.name);</span><br><span class="line"></span><br><span class="line">RetCode = task_swap_mach_voucher(task, new_voucher, &amp;old_voucher);</span><br><span class="line"></span><br><span class="line">ipc_voucher_release(new_voucher);</span><br><span class="line"></span><br><span class="line">convert_voucher_to_port(old_voucher);</span><br></pre></td></tr></table></figure>
<p>But the implementation of <code>task_swap_mach_voucher</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">kern_return_t</span></span></span><br><span class="line"><span class="function"><span class="title">task_swap_mach_voucher</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">task_t</span>			task,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">ipc_voucher_t</span>		new_voucher,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">ipc_voucher_t</span>		*in_out_old_voucher)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (TASK_NULL == task)</span><br><span class="line">		<span class="keyword">return</span> KERN_INVALID_TASK;</span><br><span class="line"></span><br><span class="line">	*in_out_old_voucher = new_voucher;</span><br><span class="line">	<span class="keyword">return</span> KERN_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Let <code>in_out_old_voucher</code> points to <code>new_voucher</code>.<br>
Notice that <code>new_voucher</code> and <code>old_voucher</code> will point to the same voucher after the swapping routine, so <code>ipc_voucher_release()</code> and <code>convert_voucher_to_port()</code> actually decrease the reference count for a same voucher twice! Actually, there are two bugs in this routine. One can release the voucher and one can increase the reference count.</p>
<h2 id="Exploit">Exploit</h2>
<p>Obviously, the routine above caused a UaF but the problems is how to exploit it. Usually, we can convert a UaF into type confusion. But vouchers are allocated in a specific kernel zone, <code>ipc.voucher</code>, in XNU. If we want to achieve type confusion attack, we need to allocate the same memory space in another kernel zone.</p>
<h3 id="Cross-Zone-Attack">Cross Zone Attack</h3>
<p>Each XNU kernel zone has a free list and the memory allocator can retrieve free memory blocks from the free list. Once the elements in the free list run out, they need to allocate memory from the OS again. So if we can force the kernel to perform garbage collection and allocate tons of memory in other zones, we can make the <code>ipc_voucher_t</code> pointer points to a new kernel zone other than <code>ipc.voucher</code>.</p>
<h4 id="Heap-Spray">Heap Spray</h4>
<p>Depending on our exploitation strategy, we have two different ways to do the heap spraying.</p>
<h5 id="OOL-Ports">OOL Ports</h5>
<p>In XNU, we can send mach ports with out-of-line messages. Let’s take a look at the following codes.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ipc_kmsg_copyin_ool_ports_descriptor(</span><br><span class="line">        <span class="keyword">mach_msg_ool_ports_descriptor_t</span> *dsc,</span><br><span class="line">        <span class="keyword">mach_msg_descriptor_t</span> *user_dsc,</span><br><span class="line">        <span class="keyword">int</span> is_64bit,</span><br><span class="line">        <span class="keyword">vm_map_t</span> <span class="built_in">map</span>,</span><br><span class="line">        <span class="keyword">ipc_space_t</span> space,</span><br><span class="line">        <span class="keyword">ipc_object_t</span> dest,</span><br><span class="line">        <span class="keyword">ipc_kmsg_t</span> kmsg,</span><br><span class="line">        <span class="keyword">mach_msg_return_t</span> *mr) &#123;</span><br><span class="line">    <span class="comment">// .........</span></span><br><span class="line">    data = kalloc(ports_length);</span><br><span class="line">    <span class="comment">// .........</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>So with specific ports count, we can kalloc in any <code>kalloc.x</code> zone we want. Here we show any example, we reallocate the <code>ith_voucher</code> field in <code>kalloc.1024</code> will <code>0xffffffffffffffff</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p (*(thread_t)0xffffff8029275840).ith_voucher</span><br><span class="line">(ipc_voucher_t) $316 = 0xffffff803527a320</span><br><span class="line">(lldb) whatis (*(thread_t)0xffffff8029275840).ith_voucher</span><br><span class="line">ADDRESS                          TYPE       OFFSET_IN_PG METADATA          </span><br><span class="line">0xffffff803527a320            Element           800/4096 0xffffff80234eed70</span><br><span class="line"></span><br><span class="line">Metadata Description:</span><br><span class="line">ZONE_METADATA      FREELIST             PG_CNT FREE_CNT ZONE               NAME                </span><br><span class="line">0xffffff80234eed70 0x0000000000000000        1        0 0xffffff801d890310 kalloc.1024</span><br><span class="line"></span><br><span class="line">Hexdump:</span><br><span class="line">ffffff803527a310  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span><br><span class="line">ffffff803527a320  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span><br><span class="line">ffffff803527a330  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span><br><span class="line">(lldb) </span><br></pre></td></tr></table></figure>
<h5 id="IOSurface">IOSurface</h5>
<p><code>IOSurfaceRootClient</code> exports <code>IOSurfaceRootUserClient::s_set_value(IOSurfaceRootUserClient*,void *,IOExternalMethodArguments *)</code> and use <code>OSUnserializeXML</code> to unserialize XML. If we pass a crafted binary data to <code>set_value</code>, we can alloc any data in any <code>kalloc.x</code> zone we want.  In this way, we can even construct a fake voucher instead of simple port pointer with OOL message.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p *(ipc_voucher_t)0xffffff802d843af0</span><br><span class="line">(ipc_voucher) $9 = &#123;</span><br><span class="line">  iv_hash = 33</span><br><span class="line">  iv_sum = 4097</span><br><span class="line">  iv_refs = 1</span><br><span class="line">  iv_table_size = 8</span><br><span class="line">  iv_inline_table = ([0] = 4097, [1] = 0, [2] = 0, [3] = 0, [4] = 0, [5] = 0, [6] = 0, [7] = 0)</span><br><span class="line">  iv_table = 0xffffff802d843b00</span><br><span class="line">  iv_port = 0xffffff802d8485e0</span><br><span class="line">  iv_hash_link = &#123;</span><br><span class="line">    next = 0xffffff802dc65280</span><br><span class="line">    prev = 0xffffff802d8341e0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">(lldb) x/16xg 0xffffff802d843af0</span><br><span class="line">0xffffff802d843af0: 0x0000100100000021 0x0000000800000001   &lt;--- overwrite with our fake voucher</span><br><span class="line">0xffffff802d843b00: 0x0000000000001001 0x0000000000000000</span><br><span class="line">0xffffff802d843b10: 0x0000000000000000 0x0000000000000000</span><br><span class="line">0xffffff802d843b20: 0xffffff802d843b00 0xffffff802d8485e0</span><br><span class="line">0xffffff802d843b30: 0xffffff802dc65280 0xffffff802d8341e0</span><br></pre></td></tr></table></figure>
<p>Also, we can even replace the <code>iv_port</code> field in <code>voucher</code>, so that we can completely control the <code>ipc_port</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(lldb) x/32xg 0xffffff80170cf690</span><br><span class="line">0xffffff80170cf690: 0x4141414141414141 0x0000000000000011   &lt;--- sum, hash, reference</span><br><span class="line">0xffffff80170cf6a0: 0x0000000000000000 0x0000000000000000</span><br><span class="line">0xffffff80170cf6b0: 0x0000000000000000 0x0000000000000000</span><br><span class="line">0xffffff80170cf6c0: 0x0000000000000000 0x0000000009556000   &lt;--- fake port</span><br><span class="line">0xffffff80170cf6d0: 0x0000000000000000 0x0000000000000000</span><br></pre></td></tr></table></figure>
<h4 id="Exploit-Strategy">Exploit Strategy</h4>
<p>Based on two different cross zone attack method, we can have two different strategy.</p>
<ul>
<li>Spray pipe buffer</li>
<li>use <code>thread_set_mach_voucher</code> to save our uaf voucher pointer</li>
<li>release the uaf voucher</li>
<li>reallocate the uaf voucher with OOL ports pointer, let <code>iv_ref</code> field overlaps with the pointer</li>
<li>use CVE-2019-6225 again to tweak <code>iv_ref</code>, move the pointer to the pipe buffer control by us.</li>
<li>construct the fake port in pipe buffer</li>
<li>receive the OOL ports again in userland</li>
<li>construct tfp0, profit!</li>
</ul>
<p>But it’s a little bit difficult to get a valid <code>iv_ref</code> value since we need to make sure the higher 31 to 27 bits are 0.</p>
<p>So we can consider the following steps</p>
<ul>
<li>use <code>thread_set_mach_voucher</code> to save our uaf voucher pointer</li>
<li>release the uaf voucher</li>
<li>replace the uaf voucher with fake voucher, and let <code>iv_port</code> points to the fake <code>ipc_port</code> in userland</li>
<li>use <code>thread_get_mach_voucher</code> to get the fake port</li>
<li>use <code>pid_for_task</code> to read kernel</li>
<li>build tfp0, profit!</li>
</ul>
<h2 id="Get-root-privilege">Get root privilege</h2>
<h3 id="KASLR">KASLR</h3>
<p>With <code>clock_sleep_trap</code> we can brute force kernel slide.</p>
<h3 id="Kernel-Read-and-Write">Kernel Read and Write</h3>
<p>We can still use <code>pid_for_task</code> to read any kernel memory once we construct our fake task. Since iOS 11, Apple added a new mitigation that only kernel can resolve kernel task port. But if we want to achieve arbitrary kernel rw, we only need the vm map of kernel task. So we can copy the <code>vm_map_t</code> pointer from kernel task to our fake task then we can get arbitrary kernel and then can get root privilege by overwriting cred. Check <a target="_blank" rel="noopener" href="https://github.com/KpwnZ/g3tr00t">https://github.com/KpwnZ/g3tr00t</a> for the exploitation detail.</p>
<h2 id="References">References</h2>
<p><a target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2019/01/voucherswap-exploiting-mig-reference.html">https://googleprojectzero.blogspot.com/2019/01/voucherswap-exploiting-mig-reference.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.siguza.net/v0rtex/">https://blog.siguza.net/v0rtex/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/PsychoTea/machswap2">https://github.com/PsychoTea/machswap2</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">KpwnZ</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://kpwnz.github.io/2022/02/01/Voucher-Port-and-Message-Exploit-CVE-2019-6225-on-macOS/">https://kpwnz.github.io/2022/02/01/Voucher-Port-and-Message-Exploit-CVE-2019-6225-on-macOS/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Vulnerability/">Vulnerability</a><a class="post-meta__tags" href="/tags/XNU/">XNU</a><a class="post-meta__tags" href="/tags/macOS/">macOS</a><a class="post-meta__tags" href="/tags/iOS/">iOS</a><a class="post-meta__tags" href="/tags/exploit/">exploit</a></div><div class="post_share"><div class="social-share" data-image="https://source.unsplash.com/featured/?landscape,tech,life" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/03/23/%E8%99%8E%E7%AC%A62022-pwn-%E5%A4%8D%E7%8E%B0/"><img class="prev-cover" src="https://source.unsplash.com/featured/?landscape,tech,life" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">虎符2022 pwn 复现</div></div></a></div><div class="next-post pull-right"><a href="/2021/11/25/Linux-kernel-pwn-in-CTF/"><img class="next-cover" src="https://source.unsplash.com/featured/?landscape,tech,life" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">An Intro to Linux Kernel Pwn in CTF</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2021/11/03/CVE-2017-2370/" title="CVE-2017-2370"><img class="cover" src="https://source.unsplash.com/featured/?landscape,tech,life" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-03</div><div class="title">CVE-2017-2370</div></div></a></div><div><a href="/2022/12/22/CVE-2022-46702-Remember-to-Clean-Up-the-Memory/" title="CVE-2022-46702: Remember to Clean Up the Memory"><img class="cover" src="https://source.unsplash.com/featured/?landscape,tech,life" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-22</div><div class="title">CVE-2022-46702: Remember to Clean Up the Memory</div></div></a></div><div><a href="/2022/07/11/CodeQL-XNU/" title="CodeQL+XNU"><img class="cover" src="https://source.unsplash.com/featured/?landscape,tech,life" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-11</div><div class="title">CodeQL+XNU</div></div></a></div><div><a href="/2022/10/03/Analyze-CVE-2022-32792-Faster-Than-Light-but-at-What-Cost/" title="Analyze CVE-2022-32792: Faster Than Light, but at What Cost?"><img class="cover" src="https://source.unsplash.com/featured/?landscape,tech,life" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-03</div><div class="title">Analyze CVE-2022-32792: Faster Than Light, but at What Cost?</div></div></a></div><div><a href="/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/" title="CVE-2020-11102: Escape from the Earth"><img class="cover" src="https://source.unsplash.com/featured/?landscape,tech,life" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-25</div><div class="title">CVE-2020-11102: Escape from the Earth</div></div></a></div><div><a href="/2022/09/30/Code-Execution-by-Hijacking-IO-FILE-vtable-in-GLIBC-2-36-0x1/" title="Code Execution by Faking IO_FILE->vtable in GLIBC 2.36 [0x1]"><img class="cover" src="https://source.unsplash.com/featured/?landscape,tech,life" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-30</div><div class="title">Code Execution by Faking IO_FILE->vtable in GLIBC 2.36 [0x1]</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://avatars.githubusercontent.com/u/22996989?s=400&amp;u=470b81ce0dd0fd2e15880f564e1bef0ba9655225&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">KpwnZ</div><div class="author-info__description">~ shit post ~</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">14</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">16</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/KpwnZ"><i class="fab fa-github"></i><span>GitHub</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">CVE-2019-6225</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Vulnerability"><span class="toc-number">1.1.</span> <span class="toc-text">Vulnerability</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploit"><span class="toc-number">1.2.</span> <span class="toc-text">Exploit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Cross-Zone-Attack"><span class="toc-number">1.2.1.</span> <span class="toc-text">Cross Zone Attack</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Heap-Spray"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">Heap Spray</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#OOL-Ports"><span class="toc-number">1.2.1.1.1.</span> <span class="toc-text">OOL Ports</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#IOSurface"><span class="toc-number">1.2.1.1.2.</span> <span class="toc-text">IOSurface</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Exploit-Strategy"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">Exploit Strategy</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Get-root-privilege"><span class="toc-number">1.3.</span> <span class="toc-text">Get root privilege</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#KASLR"><span class="toc-number">1.3.1.</span> <span class="toc-text">KASLR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kernel-Read-and-Write"><span class="toc-number">1.3.2.</span> <span class="toc-text">Kernel Read and Write</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">1.4.</span> <span class="toc-text">References</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/" title="CVE-2020-11102: Escape from the Earth"><img src="https://source.unsplash.com/featured/?landscape,tech,life" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CVE-2020-11102: Escape from the Earth"/></a><div class="content"><a class="title" href="/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/" title="CVE-2020-11102: Escape from the Earth">CVE-2020-11102: Escape from the Earth</a><time datetime="2023-04-24T16:50:54.000Z" title="Created 2023-04-25 00:50:54">2023-04-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/12/22/CVE-2022-46702-Remember-to-Clean-Up-the-Memory/" title="CVE-2022-46702: Remember to Clean Up the Memory"><img src="https://source.unsplash.com/featured/?landscape,tech,life" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CVE-2022-46702: Remember to Clean Up the Memory"/></a><div class="content"><a class="title" href="/2022/12/22/CVE-2022-46702-Remember-to-Clean-Up-the-Memory/" title="CVE-2022-46702: Remember to Clean Up the Memory">CVE-2022-46702: Remember to Clean Up the Memory</a><time datetime="2022-12-22T14:28:55.000Z" title="Created 2022-12-22 22:28:55">2022-12-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/29/evilCallback-CVE-2021-21225/" title="evilCallback: CVE-2021-21225"><img src="https://source.unsplash.com/featured/?landscape,tech,life" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="evilCallback: CVE-2021-21225"/></a><div class="content"><a class="title" href="/2022/10/29/evilCallback-CVE-2021-21225/" title="evilCallback: CVE-2021-21225">evilCallback: CVE-2021-21225</a><time datetime="2022-10-29T04:27:58.000Z" title="Created 2022-10-29 12:27:58">2022-10-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/03/Analyze-CVE-2022-32792-Faster-Than-Light-but-at-What-Cost/" title="Analyze CVE-2022-32792: Faster Than Light, but at What Cost?"><img src="https://source.unsplash.com/featured/?landscape,tech,life" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Analyze CVE-2022-32792: Faster Than Light, but at What Cost?"/></a><div class="content"><a class="title" href="/2022/10/03/Analyze-CVE-2022-32792-Faster-Than-Light-but-at-What-Cost/" title="Analyze CVE-2022-32792: Faster Than Light, but at What Cost?">Analyze CVE-2022-32792: Faster Than Light, but at What Cost?</a><time datetime="2022-10-03T13:21:51.000Z" title="Created 2022-10-03 21:21:51">2022-10-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/09/30/Code-Execution-by-Hijacking-IO-FILE-vtable-in-GLIBC-2-36-0x1/" title="Code Execution by Faking IO_FILE-&gt;vtable in GLIBC 2.36 [0x1]"><img src="https://source.unsplash.com/featured/?landscape,tech,life" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Code Execution by Faking IO_FILE-&gt;vtable in GLIBC 2.36 [0x1]"/></a><div class="content"><a class="title" href="/2022/09/30/Code-Execution-by-Hijacking-IO-FILE-vtable-in-GLIBC-2-36-0x1/" title="Code Execution by Faking IO_FILE-&gt;vtable in GLIBC 2.36 [0x1]">Code Execution by Faking IO_FILE-&gt;vtable in GLIBC 2.36 [0x1]</a><time datetime="2022-09-30T04:44:16.000Z" title="Created 2022-09-30 12:44:16">2022-09-30</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By KpwnZ</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.css"><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>